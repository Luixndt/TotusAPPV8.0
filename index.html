<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Totus - Salud Mental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --theme-primary: #0d1836;
            --theme-primary-light: #1a2f6c;
            --theme-secondary: #4f46e5;
            --theme-light-bg: #f3f4f6;
            --theme-dark-text: #1f2937;
            --theme-light-text: #f3f4f6;
            --theme-card-bg: #ffffff;
            --theme-header-bg: var(--theme-primary);
            --theme-header-text: var(--theme-light-text);
            --theme-input-border: #d1d5db;
            --theme-text-secondary: #6b7280;
        }
        body[data-theme='cerezo'] {
            --theme-primary: #d63384;
            --theme-primary-light: #e673a0;
            --theme-secondary: #f8b4d9;
            --theme-light-bg: #fff0f5;
            --theme-dark-text: #5c0029;
            --theme-light-text: #ffffff;
            --theme-card-bg: #ffffff;
            --theme-header-bg: var(--theme-primary);
            --theme-header-text: var(--theme-light-text);
            --theme-input-border: #f4c6e2;
            --theme-text-secondary: #8c5d76;
        }
        body[data-theme='serenidad'] {
            --theme-primary: #064e3b;
            --theme-primary-light: #047857;
            --theme-secondary: #a7f3d0;
            --theme-light-bg: #f0fdf4;
            --theme-dark-text: #1f2937;
            --theme-light-text: #f0fdf4;
            --theme-card-bg: #ffffff;
            --theme-header-bg: var(--theme-primary);
            --theme-header-text: var(--theme-light-text);
            --theme-input-border: #d1d5db;
            --theme-text-secondary: #6b7280;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--theme-light-bg);
            color: var(--theme-dark-text);
        }
        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-padding-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-padding-top { padding-top: env(safe-area-inset-top); }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Breathing Game */
        .breathing-circle { animation: breathe 10s ease-in-out infinite; }
        @keyframes breathe {
            0%, 100% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
        }

        /* Memory Game */
        .memory-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
        .memory-card.flip { transform: rotateY(180deg); }
        .front-face, .back-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }
        .front-face { transform: rotateY(180deg); }

        /* SOS Call Simulation */
        .pulsing-call {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Color Match Game */
        .color-match-btn.flash {
            animation: flash 0.4s ease-in-out;
        }
        @keyframes flash {
            50% { opacity: 0.5; }
        }

        /* Exercise Progress Circle */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Music Visualizer */
        @keyframes pulse-bar {
            0%, 100% { transform: scaleY(0.2); }
            50% { transform: scaleY(1); }
        }
        .visualizer-bar {
            animation: pulse-bar 1.2s ease-in-out infinite;
            transform-origin: bottom;
        }

        /* Diary drawing canvas */
        #drawing-canvas {
            touch-action: none;
            cursor: crosshair;
        }

        /* Diary Themes */
        .diary-theme-totus { --diary-bg: #f0f9ff; --diary-text: #0c4a6e; --diary-accent: #0369a1; --diary-border: #e0f2fe; --diary-input-bg: transparent; --diary-placeholder: #7dd3fc; --diary-canvas-bg: #f0f9ff; }
        .diary-theme-cerezo { --diary-bg: #fff0f5; --diary-text: #5c0029; --diary-accent: #d63384; --diary-border: #f8b4d9; --diary-input-bg: transparent; --diary-placeholder: #e673a0; --diary-canvas-bg: #fff0f5; }
        .diary-theme-serenidad { --diary-bg: #f0fdf4; --diary-text: #064e3b; --diary-accent: #059669; --diary-border: #d1fae5; --diary-input-bg: transparent; --diary-placeholder: #6ee7b7; --diary-canvas-bg: #f0fdf4; }
        
        .diary-container {
            background-color: var(--diary-bg);
            color: var(--diary-text);
        }
        .diary-container input, .diary-container textarea {
            background-color: var(--diary-input-bg);
            color: var(--diary-text);
            border-color: var(--diary-border);
        }
        .diary-container ::placeholder {
            color: var(--diary-placeholder);
            opacity: 0.8;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d1836',
                        'primary-light': '#1a2f6c',
                        secondary: '#4f46e5',
                        'accent-coral': '#ff7f50',
                        'accent-lila': '#d8b4fe',
                        'accent-yellow': '#facc15',
                        'light-bg': '#f3f4f6',
                        'dark-text': '#1f2937',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <div id="app-container" class="flex-1 overflow-y-auto no-scrollbar">
        <!-- App content is rendered here -->
    </div>
    <div id="modal-container"></div>
    <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ===================================================================================
// I. STATE & DATA MANAGEMENT
// ===================================================================================

let userData = null;
let currentView = 'home';
let onboardingStep = 0;
let onboardingData = { name: '', goals: [], condition: '' };
let selectedArticle = null;
let selectedEmotion = null;
let currentDmFriendId = null;
let currentLanguage = 'es';

const translations = {
    es: {
        welcomeTitle: "Bienvenido/a a Totus",
        welcomeSubtitle: "Tu espacio seguro para el bienestar mental.",
        getStarted: "Empezar",
        whatIsYourName: "¬øC√≥mo te llamas?",
        namePlaceholder: "Escribe tu nombre",
        back: "Volver",
        next: "Siguiente",
        whatAreYourGoals: "¬øCu√°les son tus objetivos?",
        goalsSubtitle: "Puedes seleccionar uno o m√°s.",
        goals: ["Manejar el estr√©s", "Entenderme mejor", "Reducir la ansiedad", "Crear h√°bitos positivos"],
        conditionQuestion: "¬øTe ha diagnosticado un profesional alguna condici√≥n?",
        conditionSubtitle: "Esta informaci√≥n es opcional y confidencial.",
        conditionPlaceholder: "Ej: Ansiedad, TDAH...",
        finish: "Finalizar",
        settingUp: "Configurando tu espacio...",
        sos: "SOS",
        profile: "Mi Perfil",
        greeting: { morning: "Buenos d√≠as", afternoon: "Buenas tardes", evening: "Buenas noches" },
        whatToDo: "¬øQu√© te gustar√≠a hacer hoy?",
        homeMenu: { status: "Registrar mi estado", chat: "Chat con Totus", mind: "Mind Zone", community: "Comunidad", library: "Librer√≠a" },
        howAreYou: "¬øC√≥mo te sientes hoy?",
        currentStreak: "Racha actual",
        keepItUp: "¬°Sigue as√≠!",
        days: "d√≠as",
        selectMood: "Selecciona tu estado de √°nimo",
        addReflection: "A√±ade una nota de reflexi√≥n",
        reflectionPlaceholder: "Escribe lo que sientes...",
        saveNote: "Guardar Nota",
        chatPlaceholder: "Escribe un mensaje...",
        chatWith: "Chat con",
        mindZoneTitle: "Mind Zone",
        mindZoneSubtitle: "Herramientas y actividades para tu bienestar.",
        mindZoneMenu: { tasks: "Tareas", breathing: "Respiraci√≥n", exercises: "Ejercicios", games: "Juegos", music: "M√∫sica", phrases: "Frases" },
        wellnessTasks: "Tareas de Bienestar",
        relaxingMusic: "M√∫sica Relajante",
        encouragingPhrases: "Frases de Aliento",
        relaxingGames: "Juegos Relajantes",
        guidedBreathing: "Respiraci√≥n Guiada",
        getReady: "Prep√°rate...",
        breatheIn: "Inhala",
        hold: "Sost√©n",
        breatheOut: "Exhala",
        level: "Nivel",
        best: "Mejor",
        start: "Empezar",
        gameOver: "¬°Fin del juego!",
        playAgain: "Jugar de nuevo",
        time: "Tiempo",
        reactionTest: "Test de Reacci√≥n",
        clickToStart: "Haz clic para empezar.",
        whenGreenClickAgain: "Cuando se ponga verde, haz clic de nuevo.",
        waitForGreen: "Espera al verde...",
        now: "¬°AHORA!",
        tooSoon: "¬°Demasiado pronto!",
        tryAgain: "Haz clic para intentarlo de nuevo.",
        yourTime: "Tu tiempo",
        memoryGame: "Juego de Memoria",
        moves: "Movimientos",
        exerciseCenter: "Centro de Ejercicio",
        chooseActivity: "Elige una actividad para empezar.",
        yoga: "Yoga",
        weights: "Pesas",
        running: "Correr",
        stretching: "Estiramiento",
        backToMindZone: "Volver a Mind Zone",
        exitRoutine: "Salir de la rutina",
        yogaSession: "Sesi√≥n de Yoga",
        yogaComplete: "¬°Sesi√≥n de Yoga completada!",
        yogaCompleteSub: "Siente la calma y el equilibrio. Namaste.",
        backToExercises: "Volver a Ejercicios",
        trainingComplete: "¬°Entrenamiento completado!",
        trainingCompleteSub: "¬°Siente el poder! Has hecho un gran trabajo.",
        rest: "Descanso",
        prepareForNextSet: "Prep√°rate para la siguiente serie.",
        nextExercise: "Siguiente:",
        reps: "reps",
        skipRest: "Saltar descanso",
        completeSet: "Completar Serie",
        finishTraining: "Finalizar Entrenamiento",
        runningSession: "Sesi√≥n de Carrera",
        distance: "Distancia",
        pace: "Ritmo",
        calories: "Calor√≠as",
        pause: "Pausar",
        continue: "Continuar",
        finishRun: "Finalizar",
        routineComplete: "¬°Rutina completada!",
        routineCompleteSub: "Te sientes m√°s relajado/a. ¬°Buen trabajo!",
        sounding: "Sonando",
        selectSound: "Selecciona un sonido",
        searchSounds: "Buscar sonidos...",
        all: "Todos",
        favorites: "Favoritos",
        myList: "Mi Lista",
        noSoundsFound: "No se encontraron sonidos.",
        showAnotherPhrase: "Mostrar otra frase",
        libraryTitle: "Librer√≠a de Recursos",
        searchArticles: "Buscar art√≠culos...",
        readTime: "min de lectura",
        backToLibrary: "Volver",
        communityTitle: "Comunidad",
        viewMyProfile: "Ver mi perfil",
        shareThoughts: "Comparte tus pensamientos...",
        publish: "Publicar",
        postedBy: "Publicado por:",
        likes: "Me gusta",
        comments: "Comentarios",
        noCommentsYet: "A√∫n no hay comentarios.",
        addComment: "A√±adir comentario...",
        myWall: "Mi Muro",
        changePhoto: "Cambiar Foto",
        editMotto: "Editar Lema",
        myPosts: "Mis Publicaciones",
        noPostsYet: "A√∫n no has publicado nada.",
        friends: "Amigos",
        searchFriends: "Buscar amigos...",
        noFriendsFound: "No se encontraron amigos.",
        addFriends: "A√±adir Amigos",
        sendMessage: "Enviar Mensaje",
        recentPosts: "Publicaciones Recientes",
        messages: "Mensajes",
        noMessages: "No tienes mensajes. Inicia una conversaci√≥n desde el perfil de un amigo.",
        youSentPhoto: "Enviaste una foto",
        youSentAudio: "Enviaste un mensaje de voz",
        sentYouPhoto: "Te envi√≥ una foto",
        sentYouAudio: "Te envi√≥ un mensaje de voz",
        you: "T√∫",
        memberSince: "Miembro desde",
        myMottoLabel: "Mi Lema",
        edit: "Editar",
        myStats: "Mis Estad√≠sticas",
        currentStreakStat: "Racha Actual",
        daysRegistered: "D√≠as Registrados",
        freqEmotion: "Emoci√≥n Frec.",
        moodSummary: "Resumen de √Ånimo",
        noRecords: "A√∫n no hay registros suficientes.",
        mySpace: "Mi Espacio",
        settings: "Configuraci√≥n",
        volunteer: "Voluntariado",
        donate: "Donar",
        riskLevel: "Nivel de Riesgo",
        riskLevels: { low: "Bajo", medium: "Medio", high: "Alto" },
        changeName: "Cambiar Nombre",
        save: "Guardar",
        customizeAppearance: "Personalizar Apariencia",
        language: "Idioma",
        themes: { totus: "Totus (Original)", cerezo: "Cerezo", serenidad: "Serenidad" },
        diary: {
            title: "Diario Personal",
            newEntry: "Nueva Entrada",
            previous: "Anterior",
            nextPage: "Siguiente",
            saveEntry: "Guardar",
            updateEntry: "Actualizar",
            entryTitlePlaceholder: "Escribe un t√≠tulo...",
            entryContentPlaceholder: "Escribe tu entrada aqu√≠...",
            drawingTools: { done: "Hecho", brushSize: "Grosor", eraser: "Borrador" },
            deleteEntryTitle: "¬øEliminar esta entrada?",
            deleteEntrySubtitle: "Esta acci√≥n no se puede deshacer.",
        },
        delete: "Eliminar",
        cancel: "Cancelar",
        pleaseSelectFeeling: "Por favor, selecciona c√≥mo te sientes.",
        recordSaved: "¬°Registro guardado!",
        nameUpdated: "Nombre actualizado.",
        nameNotEmpty: "El nombre no puede estar vac√≠o.",
        themeChangedTo: "Tema cambiado a",
        postShared: "¬°Publicaci√≥n compartida!",
        mottoUpdated: "Lema actualizado.",
        mottoNotEmpty: "El lema no puede estar vac√≠o.",
        commentPublished: "Comentario publicado.",
        photoUpdated: "Foto de perfil actualizada.",
        thankYouGenerosity: "¬°Gracias por tu generosidad!",
        thankYouJoining: "¬°Gracias por unirte a nosotros!",
        comingSoon: "Funci√≥n no disponible a√∫n.",
        entryCannotBeEmpty: "La entrada no puede estar vac√≠a.",
        entrySaved: "Entrada guardada.",
        entryUpdated: "Entrada actualizada.",
        entryDeleted: "Entrada eliminada.",
        supportContacts: "Contactos de Apoyo",
        supportSubtitle: "No est√°s solo/a. Aqu√≠ tienes algunos contactos de profesionales que pueden ayudarte.",
        moreInfo: "+ Informaci√≥n",
        close: "Cerrar",
        backToContacts: "Volver",
        call: "Llamar",
        scheduleAppointment: "Agendar Cita",
        calling: "Llamando a...",
        cancelCall: "Cancelar Llamada",
        joinTeam: "√önete al Equipo",
        volunteerMessage: "¬øTe apasiona la salud mental y quieres hacer la diferencia? Estamos buscando voluntarios para moderar la comunidad y crear contenido.",
        applyNow: "Aplicar ahora",
        supportTotus: "Apoya a Totus",
        donateMessage: "Tu contribuci√≥n nos ayuda a mantener y mejorar este espacio. ¬°Gracias por tu apoyo!",
    },
    en: {
        welcomeTitle: "Welcome to Totus",
        welcomeSubtitle: "Your safe space for mental wellness.",
        getStarted: "Get Started",
        whatIsYourName: "What's your name?",
        namePlaceholder: "Enter your name",
        back: "Back",
        next: "Next",
        whatAreYourGoals: "What are your goals?",
        goalsSubtitle: "You can select one or more.",
        goals: ["Manage stress", "Understand myself better", "Reduce anxiety", "Build positive habits"],
        conditionQuestion: "Have you been diagnosed with any condition by a professional?",
        conditionSubtitle: "This information is optional and confidential.",
        conditionPlaceholder: "e.g., Anxiety, ADHD...",
        finish: "Finish",
        settingUp: "Setting up your space...",
        sos: "SOS",
        profile: "My Profile",
        greeting: { morning: "Good morning", afternoon: "Good afternoon", evening: "Good evening" },
        whatToDo: "What would you like to do today?",
        homeMenu: { status: "Log my status", chat: "Chat with Totus", mind: "Mind Zone", community: "Community", library: "Library" },
        howAreYou: "How are you feeling today?",
        currentStreak: "Current streak",
        keepItUp: "Keep it up!",
        days: "days",
        selectMood: "Select your mood",
        addReflection: "Add a reflection note",
        reflectionPlaceholder: "Write what you feel...",
        saveNote: "Save Note",
        chatPlaceholder: "Type a message...",
        chatWith: "Chat with",
        mindZoneTitle: "Mind Zone",
        mindZoneSubtitle: "Tools and activities for your well-being.",
        mindZoneMenu: { tasks: "Tasks", breathing: "Breathing", exercises: "Exercises", games: "Games", music: "Music", phrases: "Phrases" },
        wellnessTasks: "Wellness Tasks",
        relaxingMusic: "Relaxing Music",
        encouragingPhrases: "Encouraging Phrases",
        relaxingGames: "Relaxing Games",
        guidedBreathing: "Guided Breathing",
        getReady: "Get ready...",
        breatheIn: "Breathe In",
        hold: "Hold",
        breatheOut: "Breathe Out",
        level: "Level",
        best: "Best",
        start: "Start",
        gameOver: "Game Over!",
        playAgain: "Play Again",
        time: "Time",
        reactionTest: "Reaction Test",
        clickToStart: "Click to start.",
        whenGreenClickAgain: "When it turns green, click again.",
        waitForGreen: "Wait for green...",
        now: "NOW!",
        tooSoon: "Too soon!",
        tryAgain: "Click to try again.",
        yourTime: "Your time",
        memoryGame: "Memory Game",
        moves: "Moves",
        exerciseCenter: "Exercise Center",
        chooseActivity: "Choose an activity to begin.",
        yoga: "Yoga",
        weights: "Weights",
        running: "Running",
        stretching: "Stretching",
        backToMindZone: "Back to Mind Zone",
        exitRoutine: "Exit routine",
        yogaSession: "Yoga Session",
        yogaComplete: "Yoga Session Completed!",
        yogaCompleteSub: "Feel the calm and balance. Namaste.",
        backToExercises: "Back to Exercises",
        trainingComplete: "Training Completed!",
        trainingCompleteSub: "Feel the power! You did a great job.",
        rest: "Rest",
        prepareForNextSet: "Prepare for the next set.",
        nextExercise: "Next:",
        reps: "reps",
        skipRest: "Skip Rest",
        completeSet: "Complete Set",
        finishTraining: "Finish Training",
        runningSession: "Running Session",
        distance: "Distance",
        pace: "Pace",
        calories: "Calories",
        pause: "Pause",
        continue: "Continue",
        finishRun: "Finish",
        routineComplete: "Routine Completed!",
        routineCompleteSub: "You feel more relaxed. Great job!",
        sounding: "Now Playing",
        selectSound: "Select a sound",
        searchSounds: "Search sounds...",
        all: "All",
        favorites: "Favorites",
        myList: "My List",
        noSoundsFound: "No sounds found.",
        showAnotherPhrase: "Show another phrase",
        libraryTitle: "Resource Library",
        searchArticles: "Search articles...",
        readTime: "min read",
        backToLibrary: "Back",
        communityTitle: "Community",
        viewMyProfile: "View my profile",
        shareThoughts: "Share your thoughts...",
        publish: "Publish",
        postedBy: "Posted by:",
        likes: "Likes",
        comments: "Comments",
        noCommentsYet: "No comments yet.",
        addComment: "Add a comment...",
        myWall: "My Wall",
        changePhoto: "Change Photo",
        editMotto: "Edit Motto",
        myPosts: "My Posts",
        noPostsYet: "You haven't posted anything yet.",
        friends: "Friends",
        searchFriends: "Search friends...",
        noFriendsFound: "No friends found.",
        addFriends: "Add Friends",
        sendMessage: "Send Message",
        recentPosts: "Recent Posts",
        messages: "Messages",
        noMessages: "You have no messages. Start a conversation from a friend's profile.",
        youSentPhoto: "You sent a photo",
        youSentAudio: "You sent a voice message",
        sentYouPhoto: "Sent you a photo",
        sentYouAudio: "Sent you a voice message",
        you: "You",
        memberSince: "Member since",
        myMottoLabel: "My Motto",
        edit: "Edit",
        myStats: "My Stats",
        currentStreakStat: "Current Streak",
        daysRegistered: "Days Registered",
        freqEmotion: "Freq. Emotion",
        moodSummary: "Mood Summary",
        noRecords: "Not enough records yet.",
        mySpace: "My Space",
        settings: "Settings",
        volunteer: "Volunteer",
        donate: "Donate",
        riskLevel: "Risk Level",
        riskLevels: { low: "Low", medium: "Medium", high: "High" },
        changeName: "Change Name",
        save: "Save",
        customizeAppearance: "Customize Appearance",
        language: "Language",
        themes: { totus: "Totus (Original)", cerezo: "Cherry Blossom", serenidad: "Serenity" },
        diary: {
            title: "Personal Diary",
            newEntry: "New Entry",
            previous: "Previous",
            nextPage: "Next",
            saveEntry: "Save",
            updateEntry: "Update",
            entryTitlePlaceholder: "Write a title...",
            entryContentPlaceholder: "Write your entry here...",
            drawingTools: { done: "Done", brushSize: "Size", eraser: "Eraser" },
            deleteEntryTitle: "Delete this entry?",
            deleteEntrySubtitle: "This action cannot be undone.",
        },
        delete: "Delete",
        cancel: "Cancel",
        pleaseSelectFeeling: "Please select how you feel.",
        recordSaved: "Record saved!",
        nameUpdated: "Name updated.",
        nameNotEmpty: "Name cannot be empty.",
        themeChangedTo: "Theme changed to",
        postShared: "Post shared!",
        mottoUpdated: "Motto updated.",
        mottoNotEmpty: "Motto cannot be empty.",
        commentPublished: "Comment published.",
        photoUpdated: "Profile photo updated.",
        thankYouGenerosity: "Thank you for your generosity!",
        thankYouJoining: "Thank you for joining us!",
        comingSoon: "Function not yet available.",
        entryCannotBeEmpty: "Entry cannot be empty.",
        entrySaved: "Entry saved.",
        entryUpdated: "Entry updated.",
        entryDeleted: "Entry deleted.",
        supportContacts: "Support Contacts",
        supportSubtitle: "You are not alone. Here are some contacts of professionals who can help you.",
        moreInfo: "More Info",
        close: "Close",
        backToContacts: "Back",
        call: "Call",
        scheduleAppointment: "Schedule Appointment",
        calling: "Calling...",
        cancelCall: "Cancel Call",
        joinTeam: "Join the Team",
        volunteerMessage: "Are you passionate about mental health and want to make a difference? We are looking for volunteers to moderate the community and create content.",
        applyNow: "Apply Now",
        supportTotus: "Support Totus",
        donateMessage: "Your contribution helps us maintain and improve this space. Thank you for your support!",
    }
};

function t(key, options = {}) {
    try {
        const keys = key.split('.');
        let result = translations[currentLanguage];
        for (const k of keys) {
            result = result[k];
            if (result === undefined) return key;
        }
        if (typeof result === 'object' && options.value) {
            result = result[options.value];
        }
        return result || key;
    } catch (error) {
        return key;
    }
}


const EMOTIONS = [
    { name: "HORRIBLE", image: "./imagenes/Recurso 2.png" },
    { name: "MAL", image: "./imagenes/Recurso 3.png" },
    { name: "OKAY", image: "./imagenes/Recurso 4.png" },
    { name: "BIEN", image: "./imagenes/Recurso 5.png" },
    { name: "GENIAL", image: "./imagenes/Recurso 6.png" }
];

const CONTENT = {
    es: {
        CHAT_RESPONSES: [
            "Entiendo. A veces los d√≠as son as√≠, y est√° bien no estar bien.",
            "Gracias por compartir. Hablar de ello es un paso valiente.",
            "Suena desafiante. Recuerda ser amable contigo mismo/a.",
            "¬øHas probado a tomarte un peque√±o descanso? Unos minutos pueden hacer la diferencia.",
            "Estoy aqu√≠ para escucharte. No est√°s solo/a en esto."
        ],
        ARTICLES: [
            { id: 1, title: "5 t√©cnicas de mindfulness para reducir la ansiedad", category: "Ansiedad", readTime: 8, image: "https://picsum.photos/seed/mindfulness/800/600", content: "El mindfulness, o atenci√≥n plena, es la pr√°ctica de prestar atenci√≥n al momento presente sin juzgar. Para la ansiedad, esto puede ser una herramienta poderosa. Aqu√≠ hay 5 t√©cnicas:\n1. Respiraci√≥n consciente: Cierra los ojos y enf√≥cate en tu respiraci√≥n...\n2. Escaneo corporal: T√∫mbate y lleva tu atenci√≥n a cada parte de tu cuerpo...\n3. Caminata consciente: Presta atenci√≥n a la sensaci√≥n de tus pies en el suelo...\n4. Observaci√≥n de pensamientos: Imagina tus pensamientos como nubes que pasan por el cielo...\n5. Alimentaci√≥n consciente: Come despacio, saboreando cada bocado..." },
            { id: 2, title: "Creando una rutina de autocuidado que funcione", category: "Autocuidado", readTime: 12, image: "https://picsum.photos/seed/selfcare/800/600", content: "El autocuidado no es ego√≠sta, es esencial. Una buena rutina debe incluir el cuidado f√≠sico, mental y emocional. Piensa en actividades peque√±as que disfrutes y puedas hacer a diario. Puede ser leer 10 p√°ginas, dar un paseo, escuchar tu m√∫sica favorita o simplemente no hacer nada durante 5 minutos. La clave es la constancia." },
            { id: 3, title: "Gu√≠a para un Sue√±o Reparador", category: "H√°bitos", readTime: 10, image: "https://picsum.photos/seed/sleep/800/600", content: "Dormir bien es crucial para la salud mental. Algunos consejos incluyen: mantener un horario regular, crear un ritual relajante antes de dormir (como leer o escuchar m√∫sica suave), asegurarse de que tu dormitorio est√© oscuro y silencioso, y evitar la cafe√≠na y las pantallas antes de acostarte. Si los problemas persisten, considera hablar con un profesional." },
            { id: 4, title: "Manejando el Estr√©s en el D√≠a a D√≠a", category: "Estr√©s", readTime: 9, image: "https://picsum.photos/seed/stress/800/600", content: "El estr√©s es una reacci√≥n natural, pero cuando es cr√≥nico, puede afectar tu salud. Identifica tus factores estresantes y busca formas de manejarlos. T√©cnicas como el ejercicio regular, una dieta balanceada, y pasar tiempo en la naturaleza pueden ayudar. No dudes en establecer l√≠mites y decir 'no' para proteger tu energ√≠a." }
        ],
        COMMUNITY_POSTS: [
            { id: 1, author: "Laura M.", content: "Hoy fue un d√≠a dif√≠cil, pero logr√© hacer mi ejercicio de respiraci√≥n. Peque√±a victoria.", likes: 15, comments: [{ author: 'Carlos R.', text: '¬°Qu√© bueno! Sigue as√≠.' }, { author: 'Ana P.', text: 'Un paso a la vez.' }] },
            { id: 2, author: "David G.", content: "¬øAlguien m√°s siente que a veces es dif√≠cil empezar el d√≠a? Buscando motivaci√≥n.", likes: 22, comments: [] },
        ],
        FRIENDS: [
            { id: 'carlos_r', name: 'Carlos R.', avatar: 'C', avatarImage: 'https://picsum.photos/seed/man-portrait-happy/200/200', posts: ["¬°D√≠a productiva! Complet√© todas mis tareas de hoy.", "Recomiendo el √∫ltimo art√≠culo sobre mindfulness. Muy √∫til."], bio: "Amante del caf√© y el desarrollo personal." },
            { id: 'ana_p', name: 'Ana P.', avatar: 'A', avatarImage: 'https://picsum.photos/seed/woman-portrait-smile/200/200', posts: ["Recordatorio: est√° bien tomarse un descanso.", "Acabo de terminar una sesi√≥n de meditaci√≥n de 10 minutos. ¬°Me siento renovada!"], bio: "Explorando el camino del autocuidado, un d√≠a a la vez." },
            { id: 'laura_m', name: 'Laura M.', avatar: 'L', avatarImage: 'https://picsum.photos/seed/person-portrait-natural/200/200', posts: ["Hoy fue un d√≠a dif√≠cil, pero logr√© hacer mi ejercicio de respiraci√≥n. Peque√±a victoria.", "Gracias a todos por el apoyo en mi √∫ltima publicaci√≥n."], bio: "Documentando mi viaje hacia una mejor salud mental." },
            { id: 'david_g', name: 'David G.', avatar: 'D', avatarImage: 'https://picsum.photos/seed/man-portrait-outdoors/200/200', posts: ["¬øAlguien m√°s siente que a veces es dif√≠cil empezar el d√≠a? Buscando motivaci√≥n.", "Salir a caminar realmente me ayud√≥ a despejar la mente."], bio: "Buscando el equilibrio entre el trabajo y la vida." },
        ],
        INITIAL_DAILY_TASKS: [
            { id: 1, text: "Meditar durante 5 minutos", completed: false }, { id: 2, text: "Escribir 3 cosas por las que est√°s agradecido", completed: false }, { id: 3, text: "Salir a caminar 15 minutos", completed: false }, { id: 4, text: "Beber 8 vasos de agua", completed: false }, { id: 5, text: "Hacer una pausa de 5 minutos sin pantallas", completed: false }, { id: 6, text: "Estirar el cuerpo por 2 minutos", completed: false },
        ],
        STRETCH_ROUTINE: [
            { name: "Estiramiento de Cuello", emoji: "üßò‚Äç‚ôÄÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1614716259433-524174b179e8?q=80&w=1887&auto=format&fit=crop", description: "Inclina suavemente la cabeza hacia un hombro. Mant√©n la posici√≥n y respira." }, { name: "C√≠rculos con los Hombros", emoji: "üôÜ‚Äç‚ôÇÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1598464332938-1e434f378a9d?q=80&w=1887&auto=format&fit=crop", description: "Gira los hombros hacia atr√°s y luego hacia adelante en un movimiento lento y controlado." }, { name: "Estiramiento de Espalda", emoji: "ü§∏‚Äç‚ôÄÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1599901860904-17e6ed7083a0?q=80&w=1887&auto=format&fit=crop", description: "Sentado, gira suavemente el torso hacia un lado. Usa la silla como apoyo." }, { name: "Estiramiento de Brazos", emoji: "üôå", duration: 30, image: "https://images.unsplash.com/photo-1598136399622-AB66e4a6d482?q=80&w=1887&auto=format&fit=crop", description: "Levanta los brazos por encima de la cabeza y est√≠rate. ¬°Buen trabajo!" }
        ],
        YOGA_ROUTINE: [
            { name: "Postura de la Monta√±a", duration: 30, image: "https://images.unsplash.com/photo-1593164842244-eff5ad82a16e?q=80&w=1887&auto=format&fit=crop", description: "P√°rate derecho, junta los pies. Siente la conexi√≥n con la tierra." }, { name: "Postura del √Årbol", duration: 45, image: "https://images.unsplash.com/photo-1591291621265-b1a1c353b27b?q=80&w=1887&auto=format&fit=crop", description: "Equil√≠brate sobre una pierna. Conc√©ntrate en un punto fijo." }, { name: "Guerrero II", duration: 45, image: "https://images.unsplash.com/photo-1597157639073-69284dc0fdaf?q=80&w=1887&auto=format&fit=crop", description: "Abre las piernas, estira los brazos. Siente tu fuerza interior." }, { name: "Postura del Ni√±o", duration: 60, image: "https://images.unsplash.com/photo-1586232684179-34b2f156d498?q=80&w=1887&auto=format&fit=crop", description: "Rel√°jate y descansa. Libera la tensi√≥n de tu espalda." }
        ],
        WEIGHTS_ROUTINE: [
            { name: "Sentadillas con Peso", sets: 3, reps: 10, image: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=2070&auto=format&fit=crop" }, { name: "Press de Banca", sets: 3, reps: 8, image: "https://images.unsplash.com/photo-1574680122432-247a3e798052?q=80&w=2070&auto=format&fit=crop" }, { name: "Remo con Mancuerna", sets: 3, reps: 12, image: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop" }
        ],
        MENTAL_HEALTH_PROFESSIONALS: [
            { name: "Dra. Elena Garc√≠a", specialty: "Terapia Cognitivo-Conductual", email: "elena.garcia@saludmental.com", website: "elenagarcia.com", bio: "Especialista en TCC con m√°s de 10 a√±os de experiencia ayudando a pacientes a superar la ansiedad y la depresi√≥n.", avatarImage: "https://images.unsplash.com/photo-1557862921-37829c790f19?q=80&w=2071&auto=format&fit=crop" }, { name: "Dr. Marcos Reyes", specialty: "Psicolog√≠a Cl√≠nica", email: "marcos.reyes@saludmental.com", website: "marcosreyes.com", bio: "Enfocado en el tratamiento de trastornos del estado de √°nimo y desarrollo de la resiliencia personal.", avatarImage: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=1887&auto=format&fit=crop" }, { name: "Lic. Sof√≠a Navarro", specialty: "Manejo de Ansiedad", email: "sofia.navarro@saludmental.com", website: "sofianavarro.com", bio: "Utiliza t√©cnicas de mindfulness y relajaci√≥n para proporcionar herramientas pr√°cticas contra la ansiedad.", avatarImage: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1887&auto=format&fit=crop" }, { name: "Psic. Javier Torres", specialty: "Mindfulness y Estr√©s", email: "javier.torres@saludmental.com", website: "javiertorres.com", bio: "Experto en la aplicaci√≥n de la atenci√≥n plena para la gesti√≥n del estr√©s laboral y personal.", avatarImage: "https://images.unsplash.com/photo-1590086782792-42dd2350140d?q=80&w=1887&auto=format&fit=crop" }
        ],
        RELAXING_SOUNDS: [
            { id: 1, name: "Lluvia Suave", icon: "fa-cloud-showers-heavy", image: "https://picsum.photos/seed/rainy-day/600/400" }, { id: 2, name: "Olas del Mar", icon: "fa-water", image: "https://picsum.photos/seed/ocean-waves/600/400" }, { id: 3, name: "Bosque Tranquilo", icon: "fa-tree", image: "https://picsum.photos/seed/forest-path/600/400" }, { id: 4, name: "Fuego de Hogar", icon: "fa-fire", image: "https://picsum.photos/seed/cozy-fire/600/400" }, { id: 5, name: "Noche de Verano", icon: "fa-moon", image: "https://picsum.photos/seed/summer-night/600/400" }, { id: 6, name: "P√°jaros Cantando", icon: "fa-dove", image: "https://picsum.photos/seed/bird-song/600/400" }, { id: 7, name: "Sonido Blanco", icon: "fa-fan", image: "https://picsum.photos/seed/white-noise/600/400" }, { id: 8, name: "Corriente de R√≠o", icon: "fa-water", image: "https://picsum.photos/seed/river-stream/600/400" }
        ],
        ENCOURAGING_PHRASES: [
            "Cada d√≠a es una nueva oportunidad para cambiar tu vida.", "Eres m√°s fuerte de lo que crees.", "El progreso, no la perfecci√≥n, es lo que importa.", "Perm√≠tete sentir. Perm√≠tete sanar. Perm√≠tete crecer.", "Tu salud mental es una prioridad. Tu felicidad es una prioridad. Tu autocuidado es una prioridad.", "Respira. Has llegado hasta aqu√≠. Puedes seguir adelante."
        ]
    },
    en: {
        CHAT_RESPONSES: [
            "I understand. Some days are like that, and it's okay not to be okay.", "Thank you for sharing. Talking about it is a brave step.", "That sounds challenging. Remember to be kind to yourself.", "Have you tried taking a short break? A few minutes can make a difference.", "I'm here to listen. You're not alone in this."
        ],
        ARTICLES: [
            { id: 1, title: "5 Mindfulness Techniques to Reduce Anxiety", category: "Anxiety", readTime: 8, image: "https://picsum.photos/seed/mindfulness/800/600", content: "Mindfulness is the practice of paying attention to the present moment without judgment. For anxiety, this can be a powerful tool. Here are 5 techniques:\n1. Conscious breathing: Close your eyes and focus on your breath...\n2. Body scan: Lie down and bring your attention to each part of your body...\n3. Mindful walking: Pay attention to the sensation of your feet on the ground...\n4. Observation of thoughts: Imagine your thoughts as clouds passing in the sky...\n5. Mindful eating: Eat slowly, savoring each bite..." },
            { id: 2, title: "Creating a Self-Care Routine That Works", category: "Self-Care", readTime: 12, image: "https://picsum.photos/seed/selfcare/800/600", content: "Self-care isn't selfish, it's essential. A good routine should include physical, mental, and emotional care. Think of small activities you enjoy and can do daily. It could be reading 10 pages, taking a walk, listening to your favorite music, or just doing nothing for 5 minutes. The key is consistency." },
            { id: 3, title: "A Guide to Restful Sleep", category: "Habits", readTime: 10, image: "https://picsum.photos/seed/sleep/800/600", content: "Sleeping well is crucial for mental health. Some tips include: keeping a regular schedule, creating a relaxing ritual before bed (like reading or listening to soft music), making sure your bedroom is dark and quiet, and avoiding caffeine and screens before bedtime. If problems persist, consider talking to a professional." },
            { id: 4, title: "Managing Everyday Stress", category: "Stress", readTime: 9, image: "https://picsum.photos/seed/stress/800/600", content: "Stress is a natural reaction, but when it's chronic, it can affect your health. Identify your stressors and find ways to manage them. Techniques like regular exercise, a balanced diet, and spending time in nature can help. Don't hesitate to set boundaries and say 'no' to protect your energy." }
        ],
        COMMUNITY_POSTS: [
            { id: 1, author: "Laura M.", content: "Today was a tough day, but I managed to do my breathing exercise. Small victory.", likes: 15, comments: [{ author: 'Carlos R.', text: 'That\'s great! Keep it up.' }, { author: 'Ana P.', text: 'One step at a time.' }] },
            { id: 2, author: "David G.", content: "Does anyone else feel like it's hard to start the day sometimes? Looking for motivation.", likes: 22, comments: [] },
        ],
        FRIENDS: [
            { id: 'carlos_r', name: 'Carlos R.', avatar: 'C', avatarImage: 'https://picsum.photos/seed/man-portrait-happy/200/200', posts: ["Productive day! Completed all my tasks for today.", "I recommend the latest article on mindfulness. Very useful."], bio: "Lover of coffee and personal development." },
            { id: 'ana_p', name: 'Ana P.', avatar: 'A', avatarImage: 'https://picsum.photos/seed/woman-portrait-smile/200/200', posts: ["Reminder: it's okay to take a break.", "Just finished a 10-minute meditation session. I feel refreshed!"], bio: "Exploring the path of self-care, one day at a time." },
            { id: 'laura_m', name: 'Laura M.', avatar: 'L', avatarImage: 'https://picsum.photos/seed/person-portrait-natural/200/200', posts: ["Today was a tough day, but I managed to do my breathing exercise. Small victory.", "Thanks everyone for the support on my last post."], bio: "Documenting my journey to better mental health." },
            { id: 'david_g', name: 'David G.', avatar: 'D', avatarImage: 'https://picsum.photos/seed/man-portrait-outdoors/200/200', posts: ["Does anyone else feel like it's hard to start the day sometimes? Looking for motivation.", "Going for a walk really helped clear my mind."], bio: "Seeking balance between work and life." },
        ],
        INITIAL_DAILY_TASKS: [
            { id: 1, text: "Meditate for 5 minutes", completed: false }, { id: 2, text: "Write 3 things you are grateful for", completed: false }, { id: 3, text: "Go for a 15-minute walk", completed: false }, { id: 4, text: "Drink 8 glasses of water", completed: false }, { id: 5, text: "Take a 5-minute screen-free break", completed: false }, { id: 6, text: "Stretch your body for 2 minutes", completed: false },
        ],
        STRETCH_ROUTINE: [
            { name: "Neck Stretch", emoji: "üßò‚Äç‚ôÄÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1614716259433-524174b179e8?q=80&w=1887&auto=format&fit=crop", description: "Gently tilt your head towards one shoulder. Hold and breathe." }, { name: "Shoulder Circles", emoji: "üôÜ‚Äç‚ôÇÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1598464332938-1e434f378a9d?q=80&w=1887&auto=format&fit=crop", description: "Roll your shoulders backwards and then forwards in a slow, controlled motion." }, { name: "Back Stretch", emoji: "ü§∏‚Äç‚ôÄÔ∏è", duration: 30, image: "https://images.unsplash.com/photo-1599901860904-17e6ed7083a0?q=80&w=1887&auto=format&fit=crop", description: "While seated, gently twist your torso to one side. Use the chair for support." }, { name: "Arm Stretch", emoji: "üôå", duration: 30, image: "https://images.unsplash.com/photo-1598136399622-AB66e4a6d482?q=80&w=1887&auto=format&fit=crop", description: "Raise your arms above your head and stretch. Good job!" }
        ],
        YOGA_ROUTINE: [
            { name: "Mountain Pose", duration: 30, image: "https://images.unsplash.com/photo-1593164842244-eff5ad82a16e?q=80&w=1887&auto=format&fit=crop", description: "Stand straight, feet together. Feel your connection to the earth." }, { name: "Tree Pose", duration: 45, image: "https://images.unsplash.com/photo-1591291621265-b1a1c353b27b?q=80&w=1887&auto=format&fit=crop", description: "Balance on one leg. Focus on a fixed point." }, { name: "Warrior II", duration: 45, image: "https://images.unsplash.com/photo-1597157639073-69284dc0fdaf?q=80&w=1887&auto=format&fit=crop", description: "Open your legs, stretch your arms. Feel your inner strength." }, { name: "Child's Pose", duration: 60, image: "https://images.unsplash.com/photo-1586232684179-34b2f156d498?q=80&w=1887&auto=format&fit=crop", description: "Relax and rest. Release the tension in your back." }
        ],
        WEIGHTS_ROUTINE: [
            { name: "Weighted Squats", sets: 3, reps: 10, image: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=2070&auto=format&fit=crop" }, { name: "Bench Press", sets: 3, reps: 8, image: "https://images.unsplash.com/photo-1574680122432-247a3e798052?q=80&w=2070&auto=format&fit=crop" }, { name: "Dumbbell Row", sets: 3, reps: 12, image: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop" }
        ],
        MENTAL_HEALTH_PROFESSIONALS: [
            { name: "Dr. Elena Garcia", specialty: "Cognitive-Behavioral Therapy", email: "elena.garcia@mentalhealth.com", website: "elenagarcia.com", bio: "CBT specialist with over 10 years of experience helping patients overcome anxiety and depression.", avatarImage: "https://images.unsplash.com/photo-1557862921-37829c790f19?q=80&w=2071&auto=format&fit=crop" }, { name: "Dr. Marcos Reyes", specialty: "Clinical Psychology", email: "marcos.reyes@mentalhealth.com", website: "marcosreyes.com", bio: "Focused on treating mood disorders and developing personal resilience.", avatarImage: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=1887&auto=format&fit=crop" }, { name: "Sofia Navarro, LCSW", specialty: "Anxiety Management", email: "sofia.navarro@mentalhealth.com", website: "sofianavarro.com", bio: "Uses mindfulness and relaxation techniques to provide practical tools against anxiety.", avatarImage: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1887&auto=format&fit=crop" }, { name: "Javier Torres, PsyD", specialty: "Mindfulness and Stress", email: "javier.torres@mentalhealth.com", website: "javiertorres.com", bio: "Expert in applying mindfulness for managing work-related and personal stress.", avatarImage: "https://images.unsplash.com/photo-1590086782792-42dd2350140d?q=80&w=1887&auto=format&fit=crop" }
        ],
        RELAXING_SOUNDS: [
            { id: 1, name: "Soft Rain", icon: "fa-cloud-showers-heavy", image: "https://picsum.photos/seed/rainy-day/600/400" }, { id: 2, name: "Ocean Waves", icon: "fa-water", image: "https://picsum.photos/seed/ocean-waves/600/400" }, { id: 3, name: "Quiet Forest", icon: "fa-tree", image: "https://picsum.photos/seed/forest-path/600/400" }, { id: 4, name: "Fireplace", icon: "fa-fire", image: "https://picsum.photos/seed/cozy-fire/600/400" }, { id: 5, name: "Summer Night", icon: "fa-moon", image: "https://picsum.photos/seed/summer-night/600/400" }, { id: 6, name: "Birds Singing", icon: "fa-dove", image: "https://picsum.photos/seed/bird-song/600/400" }, { id: 7, name: "White Noise", icon: "fa-fan", image: "https://picsum.photos/seed/white-noise/600/400" }, { id: 8, name: "River Stream", icon: "fa-water", image: "https://picsum.photos/seed/river-stream/600/400" }
        ],
        ENCOURAGING_PHRASES: [
            "Every day is a new opportunity to change your life.", "You are stronger than you think.", "Progress, not perfection, is what matters.", "Allow yourself to feel. Allow yourself to heal. Allow yourself to grow.", "Your mental health is a priority. Your happiness is a priority. Your self-care is a priority.", "Breathe. You've made it this far. You can keep going."
        ]
    }
};

let COMMUNITY_POSTS = [];
let currentPhrase = '';
let musicState = { currentTab: 'all', searchTerm: '' };
let diaryState = { view: 'notebook', entryId: null, currentPageIndex: 0, isDrawing: false, tempDrawing: null };
let currentMusic = { track: null, isPlaying: false };

function loadUserData() {
    const savedData = localStorage.getItem('totusUserData');
    if (savedData) {
        userData = JSON.parse(savedData);
        currentLanguage = userData.language || 'es';

        if (!userData.dailyTasks) userData.dailyTasks = JSON.parse(JSON.stringify(CONTENT[currentLanguage].INITIAL_DAILY_TASKS));
        if (!userData.gameScores) userData.gameScores = { colorMatch: 0, reactionTime: 9999 };
        if (!userData.likedPosts) userData.likedPosts = [];
        if (!userData.directMessages) userData.directMessages = {};
        if (!userData.avatarImage) userData.avatarImage = `https://picsum.photos/seed/${userData.name || 'default'}/200/200`;
        if (!userData.bio) userData.bio = "Mi viaje hacia el bienestar. Un d√≠a a la vez.";
        if (!userData.musicFavorites) userData.musicFavorites = [];
        if (!userData.musicPlaylist) userData.musicPlaylist = [];
        if (!userData.diaryEntries) userData.diaryEntries = [];
        if (!userData.appTheme) userData.appTheme = 'totus';
    } else {
        currentLanguage = 'es';
    }

    const savedPosts = localStorage.getItem('totusCommunityPosts');
    if (savedPosts) {
        COMMUNITY_POSTS = JSON.parse(savedPosts);
    } else {
        COMMUNITY_POSTS = JSON.parse(JSON.stringify(CONTENT[currentLanguage].COMMUNITY_POSTS));
    }
    currentPhrase = CONTENT[currentLanguage].ENCOURAGING_PHRASES[0];
}

function saveUserData() {
    if (userData) {
        localStorage.setItem('totusUserData', JSON.stringify(userData));
    }
}

function saveCommunityPosts() {
    localStorage.setItem('totusCommunityPosts', JSON.stringify(COMMUNITY_POSTS));
}

function createNewUser(data) {
    const lang = currentLanguage;
    return {
        name: data.name || "Usuario",
        avatarImage: `https://picsum.photos/seed/${data.name || 'newuser'}/200/200`,
        bio: lang === 'es' ? "Mi viaje hacia el bienestar. Un d√≠a a la vez." : "My journey to wellness. One day at a time.",
        joinDate: new Date().toISOString().split('T')[0],
        streak: 0,
        emotionHistory: [],
        chatHistory: [
            { id: Date.now(), text: lang === 'es' ? `Hola ${data.name || 't√∫'}, bienvenido/a a Totus. Estoy aqu√≠ para ayudarte. ¬øC√≥mo te sientes hoy?` : `Hi ${data.name || 'you'}, welcome to Totus. I'm here to help you. How are you feeling today?`, sender: 'totus' }
        ],
        goals: data.goals,
        condition: data.condition,
        dailyTasks: JSON.parse(JSON.stringify(CONTENT[lang].INITIAL_DAILY_TASKS)),
        gameScores: { colorMatch: 0, reactionTime: 9999 },
        likedPosts: [],
        directMessages: {},
        musicFavorites: [],
        musicPlaylist: [],
        diaryEntries: [],
        appTheme: 'totus',
        language: lang
    };
}


// ===================================================================================
// II. RENDER FUNCTIONS (HTML TEMPLATES)
// ===================================================================================

const appContainer = document.getElementById('app-container');

function render() {
    if (onboardingStep < 99) {
        renderOnboarding();
    } else if (userData) {
        if (currentView === 'profile') {
            renderProfilePage();
        } else {
            renderMainAppContent();
        }
    }
}

function renderMainAppContent() {
    let viewContent = '';
    if (selectedArticle) {
        viewContent = getArticleDetailHTML(selectedArticle);
    } else if (currentView === 'dm' && currentDmFriendId) {
        viewContent = getDirectMessageViewHTML(currentDmFriendId);
    } else {
        switch (currentView) {
            case 'home':      viewContent = getHomeViewHTML(); break;
            case 'status':    viewContent = getStatusViewHTML(); break;
            case 'chat':      viewContent = getChatViewHTML(); break;
            case 'mind':      viewContent = getMindZoneViewHTML(); break;
            case 'community': viewContent = getCommunityViewHTML(); break;
            case 'library':   viewContent = getLibraryViewHTML(); break;
        }
    }
    
    appContainer.innerHTML = `
        ${currentView === 'dm' ? getDMHeaderHTML(currentDmFriendId) : getHeaderHTML()}
        <main class="pt-20 pb-4">
            <div class="fade-in" id="view-content">${viewContent}</div>
        </main>
    `;
    
    attachContentEventListeners();
}

function renderProfilePage() {
    appContainer.innerHTML = getProfileViewHTML();
    attachProfileListeners();
}

function getHeaderHTML() {
    return `
        <header class="fixed top-0 left-0 right-0 bg-[var(--theme-header-bg)] text-[var(--theme-header-text)] p-4 flex justify-between items-center shadow-md z-20 safe-padding-top">
            <div class="flex-1"></div>
            <div class="flex-1 text-center">
                 <button id="logo-btn"><img src="./imagenes/Logo.png" alt="Totus Logo" class="h-15 inline-block" /></button>
            </div>
            <div class="flex-1 flex justify-end items-center space-x-4">
                <button id="sos-btn" class="bg-red-500 text-white font-bold py-2 px-3 rounded-full text-sm">${t('sos')}</button>
                <button id="profile-btn" class="text-2xl"><i class="fa-solid fa-circle-user"></i></button>
            </div>
        </header>`;
}

function getDMHeaderHTML(friendId) {
    const friend = CONTENT[currentLanguage].FRIENDS.find(f => f.id === friendId);
    if (!friend) return getHeaderHTML();
    return `
        <header class="fixed top-0 left-0 right-0 bg-[var(--theme-header-bg)] text-[var(--theme-header-text)] p-4 flex items-center shadow-md z-20 safe-padding-top">
            <button id="back-from-dm-btn" class="text-2xl w-10"><i class="fas fa-arrow-left"></i></button>
            <div class="flex items-center space-x-3 flex-1">
                 <img src="${friend.avatarImage}" alt="${friend.name}" class="w-10 h-10 rounded-full object-cover"/>
                 <h1 class="text-xl font-bold">${friend.name}</h1>
            </div>
            <div class="w-10"></div> <!-- Spacer -->
        </header>`;
}

function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return t('greeting.morning');
    if (hour < 19) return t('greeting.afternoon');
    return t('greeting.evening');
}

function getHomeViewHTML() {
    const homeItems = [
        { view: 'status', label: t('homeMenu.status'), icon: './imagenes/1.png' },
        { view: 'chat', label: t('homeMenu.chat'), icon: './imagenes/2.png' },
        { view: 'mind', label: t('homeMenu.mind'), icon: './imagenes/3.png' },
        { view: 'community', label: t('homeMenu.community'), icon: './imagenes/4.png' },
        { view: 'library', label: t('homeMenu.library'), icon: './imagenes/5.png' },
    ];
    return `
        <div class="p-4 space-y-6">
            <h2 class="text-3xl font-bold text-[var(--theme-dark-text)]">${getGreeting()},<br/>${userData.name}.</h2>
            <p style="color: var(--theme-text-secondary);" class="text-base">${t('whatToDo')}</p>
            <div class="space-y-3">
                ${homeItems.map(item => `
                    <button data-view="${item.view}" class="nav-btn w-full bg-[var(--theme-card-bg)] p-4 rounded-2xl shadow-md flex items-center transition-transform transform hover:scale-105">
                        <img src="${item.icon}" alt="${item.label}" class="w-10 h-10 mr-4"/>
                        <span class="font-semibold text-lg text-[var(--theme-dark-text)]">${item.label}</span>
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

function getStatusViewHTML() {
    return `
        <div class="p-4 space-y-5">
            <button class="back-to-home-btn mb-2 text-[var(--theme-primary)] text-2xl"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-[var(--theme-dark-text)]">${t('howAreYou')}</h2>
            <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md flex justify-between items-center bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-primary-light)] text-white">
                <div><p class="font-bold text-lg">${t('currentStreak')}</p><p class="text-sm">${t('keepItUp')}</p></div>
                <div class="text-4xl font-bold">${userData.streak} üî• <span class="text-lg">${t('days')}</span></div>
            </div>
            <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                <h3 class="font-semibold text-[var(--theme-dark-text)] mb-3">${t('selectMood')}</h3>
                <div class="grid grid-cols-5 gap-2 text-center">
                    ${EMOTIONS.map(e => `<button data-emotion="${e.name}" class="emotion-btn p-2 rounded-lg transition-all duration-200 transform hover:scale-110 ${selectedEmotion === e.name ? 'bg-accent-lila ring-2 ring-[var(--theme-primary)]' : 'bg-[var(--theme-light-bg)]'}"><img src="${e.image}" alt="${e.name}" class="w-10 h-10 mx-auto" /><span class="text-xs font-medium text-[var(--theme-dark-text)] mt-1 block">${e.name}</span></button>`).join('')}
                </div>
            </div>
            <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                 <h3 class="font-semibold text-[var(--theme-dark-text)] mb-2">${t('addReflection')}</h3>
                 <textarea id="note-input" rows="4" placeholder="${t('reflectionPlaceholder')}" class="w-full p-2 border border-[var(--theme-input-border)] rounded-lg focus:ring-2 focus:ring-[var(--theme-primary)] focus:border-transparent bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]"></textarea>
            </div>
            <button id="save-note-btn" class="w-full bg-[var(--theme-primary)] text-white font-bold py-3 px-4 rounded-lg">${t('saveNote')}</button>
        </div>`;
}

function getChatViewHTML() {
    return `
        <div class="p-4"><button class="back-to-home-btn text-[var(--theme-primary)] text-2xl"><i class="fas fa-arrow-left"></i></button></div>
        <div class="flex flex-col" style="height: calc(100vh - 145px);">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                ${userData.chatHistory.map(msg => `
                    <div class="flex items-end gap-2 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                        ${msg.sender === 'totus' ? `<img src="./imagenes/totus.png" alt="Totus" class="w-20 h-20 rounded-full" />` : ''}
                        <div class="max-w-xs p-3 rounded-2xl ${msg.sender === 'user' ? 'bg-[var(--theme-primary)] text-white rounded-br-none' : 'bg-gray-200 text-dark-text rounded-bl-none'}"><p>${msg.text}</p></div>
                    </div>`).join('')}
            </div>
            <div class="p-4 bg-[var(--theme-card-bg)] border-t border-[var(--theme-input-border)] shrink-0">
                <div class="flex items-center space-x-2">
                    <input id="chat-input" type="text" placeholder="${t('chatPlaceholder')}" class="flex-1 p-3 border border-[var(--theme-input-border)] rounded-full bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" />
                    <button id="chat-send-btn" class="bg-[var(--theme-primary)] text-white rounded-full w-12 h-12 flex items-center justify-center text-xl"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>`;
}

function getMindZoneViewHTML() {
    const mindZoneItems = [
        { id: 'tasks', icon: 'fa-check-double', color: 'text-accent-yellow', label: t('mindZoneMenu.tasks') },
        { id: 'breathing', icon: 'fa-wind', color: 'text-accent-lila', label: t('mindZoneMenu.breathing') },
        { id: 'exercises', icon: 'fa-person-walking', color: 'text-green-500', label: t('mindZoneMenu.exercises') },
        { id: 'games', icon: 'fa-gamepad', color: 'text-blue-500', label: t('mindZoneMenu.games') },
        { id: 'music', icon: 'fa-music', color: 'text-red-500', label: t('mindZoneMenu.music') },
        { id: 'phrases', icon: 'fa-quote-left', color: 'text-orange-500', label: t('mindZoneMenu.phrases') },
    ];
    return `
        <div class="p-4">
            <button class="back-to-home-btn mb-2 text-[var(--theme-primary)] text-2xl"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-[var(--theme-dark-text)] mb-4">${t('mindZoneTitle')}</h2>
            <p style="color: var(--theme-text-secondary);" class="mb-6">${t('mindZoneSubtitle')}</p>
            <div id="mind-zone-content" class="grid grid-cols-2 gap-4">
                ${mindZoneItems.map(item => `
                     <button data-section="${item.id}" class="mind-zone-btn bg-[var(--theme-card-bg)] p-4 rounded-2xl shadow-md text-center transition-transform transform hover:scale-105">
                        <i class="fas ${item.icon} ${item.color} text-4xl mb-2"></i>
                        <p class="font-semibold text-[var(--theme-dark-text)]">${item.label}</p>
                    </button>
                `).join('')}
            </div>
        </div>`;
}

function getLibraryViewHTML() {
    return `
        <div class="p-4 space-y-4">
            <button class="back-to-home-btn mb-2 text-[var(--theme-primary)] text-2xl"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-[var(--theme-dark-text)]">${t('libraryTitle')}</h2>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fas fa-search" style="color: var(--theme-text-secondary);"></i>
                </span>
                <input type="text" placeholder="${t('searchArticles')}" class="w-full p-3 pl-10 border border-[var(--theme-input-border)] rounded-lg bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" />
            </div>
            <div id="library-articles" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${CONTENT[currentLanguage].ARTICLES.map(a => `
                    <div data-article-id="${a.id}" class="article-card bg-[var(--theme-card-bg)] rounded-2xl shadow-md cursor-pointer overflow-hidden transition-transform transform hover:scale-105">
                        <img src="${a.image}" alt="${a.title}" class="w-full h-32 object-cover" />
                        <div class="p-4">
                            <p class="text-xs font-bold uppercase text-[var(--theme-primary)]">${a.category}</p>
                            <h3 class="text-lg font-bold text-[var(--theme-dark-text)] mt-1">${a.title}</h3>
                            <p class="text-sm mt-2" style="color: var(--theme-text-secondary);">${a.readTime} ${t('readTime')}</p>
                        </div>
                    </div>`).join('')}
            </div>
        </div>`;
}

function getArticleDetailHTML(article) {
     return `
        <div class="p-4">
             <button id="back-to-library-btn" class="mb-4 text-[var(--theme-primary)] font-semibold"><i class="fas fa-arrow-left mr-2"></i> ${t('backToLibrary')}</button>
             <h2 class="text-2xl font-bold text-[var(--theme-dark-text)] mb-2">${article.title}</h2>
             <p class="text-sm mb-4" style="color: var(--theme-text-secondary);">${article.category} - ${article.readTime} ${t('readTime')}</p>
             <div class="prose max-w-none text-[var(--theme-dark-text)]">${article.content.replace(/\n/g, '<br />')}</div>
        </div>`;
}

function getCommunityViewHTML() {
     return `
        <div class="p-4 space-y-4">
            <button class="back-to-home-btn mb-2 text-[var(--theme-primary)] text-2xl"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-[var(--theme-dark-text)]">${t('communityTitle')}</h2>
            
            <div class="bg-[var(--theme-card-bg)] rounded-2xl shadow-md p-4">
                <div class="flex items-center justify-between mb-4">
                    <button id="community-profile-btn" class="flex items-center space-x-3">
                        <img src="${userData.avatarImage}" alt="${userData.name}" class="w-12 h-12 rounded-full object-cover"/>
                        <div>
                            <p class="font-bold text-[var(--theme-dark-text)]">${userData.name}</p>
                            <p class="text-sm" style="color: var(--theme-text-secondary);">${t('viewMyProfile')}</p>
                        </div>
                    </button>
                    <div class="flex items-center space-x-4 text-2xl" style="color: var(--theme-text-secondary);">
                        <button id="community-messages-btn" class="hover:text-[var(--theme-primary)]"><i class="fas fa-comment-dots"></i></button>
                        <button id="community-friends-btn" class="hover:text-[var(--theme-primary)]"><i class="fas fa-user-friends"></i></button>
                        <button id="community-search-btn" class="hover:text-[var(--theme-primary)]"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <textarea id="new-post-input" placeholder="${t('shareThoughts')}" class="w-full p-2 border rounded-lg bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)] border-[var(--theme-input-border)]" rows="3"></textarea>
                <button id="publish-post-btn" class="w-full mt-2 bg-[var(--theme-primary)] text-white font-bold py-2 px-4 rounded-lg">${t('publish')}</button>
            </div>

            <div id="community-posts" class="space-y-4">
                ${COMMUNITY_POSTS.map(post => {
                    const isLiked = userData.likedPosts && userData.likedPosts.includes(post.id);
                    return `
                    <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                        <p class="text-sm font-semibold text-[var(--theme-primary)] mb-2">${t('postedBy')} ${post.author}</p>
                        <p class="text-[var(--theme-dark-text)] my-4">${post.content}</p>
                        <div class="flex justify-end items-center space-x-4 border-t pt-2 border-[var(--theme-input-border)]" style="color: var(--theme-text-secondary);">
                            <button data-post-id="${post.id}" class="like-btn ${isLiked ? 'text-red-500' : ''} hover:text-red-500 transition-colors">
                                <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart mr-1"></i> ${post.likes}
                            </button>
                            <button data-post-id="${post.id}" class="comment-btn hover:text-[var(--theme-primary)] transition-colors">
                                <i class="fa-solid fa-comment mr-1"></i> ${post.comments.length}
                            </button>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
}

function getDirectMessageViewHTML(friendId) {
    const friend = CONTENT[currentLanguage].FRIENDS.find(f => f.id === friendId);
    if (!friend) return `<p class="p-4">Amigo no encontrado.</p>`;
    
    const messages = userData.directMessages[friendId] || [];

    return `
        <div class="flex flex-col" style="height: calc(100vh - 96px);">
            <div id="dm-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                ${messages.map(msg => {
                    let contentHTML = '';
                    let paddingClass = 'p-3';
                    let backgroundClass = msg.sender === 'user' ? 'bg-[var(--theme-primary)]' : 'bg-gray-200';
                    let textColorClass = msg.sender === 'user' ? 'text-white' : 'text-dark-text';

                    if (document.body.dataset.theme === 'noche' && msg.sender !== 'user') {
                        backgroundClass = 'bg-gray-700';
                        textColorClass = 'text-gray-200';
                    }

                    if (msg.type === 'photo') {
                        paddingClass = 'p-1';
                        contentHTML = `<img src="${msg.url}" class="w-48 max-w-full h-auto rounded-xl object-cover" alt="Imagen enviada"/>`;
                    } else if (msg.type === 'audio') {
                        const audioTextColor = msg.sender === 'user' ? 'text-gray-300' : 'text-gray-500';
                        const audioIconColor = msg.sender === 'user' ? 'text-white' : 'text-primary';
                         if (document.body.dataset.theme === 'noche') {
                            if (msg.sender === 'user') { audioIconColor = 'text-white'; } else { audioIconColor = 'text-secondary'; }
                         }
                        
                        const audioPlayerColor = msg.sender === 'user' ? 'bg-white' : 'bg-primary';
                        const audioScrubberColor = msg.sender === 'user' ? 'bg-gray-500/50' : 'bg-gray-400';
                        contentHTML = `
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-play-circle text-2xl ${audioIconColor}"></i>
                                <div class="w-32 h-1 ${audioScrubberColor} rounded-full relative">
                                    <div class="${audioPlayerColor} h-1 absolute top-0 left-0 rounded-full" style="width: 66%;"></div>
                                    <div class="${audioPlayerColor} w-3 h-3 rounded-full absolute top-1/2 -mt-1.5" style="left: calc(66% - 6px);"></div>
                                </div>
                                <span class="text-xs ${audioTextColor}">0:12</span>
                            </div>
                        `;
                    } else { // text
                        contentHTML = `<p>${msg.text}</p>`;
                    }

                    return `
                        <div class="flex items-end gap-2 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                            ${msg.sender === 'friend' ? `<img src="${friend.avatarImage}" class="w-8 h-8 rounded-full object-cover"/>` : ''}
                            <div class="max-w-xs ${paddingClass} rounded-2xl ${msg.sender === 'user' ? `rounded-br-none ${backgroundClass}` : `rounded-bl-none ${backgroundClass}`} ${textColorClass}">
                                ${contentHTML}
                            </div>
                        </div>`;
                }).join('')}
            </div>
            <div class="p-4 bg-[var(--theme-card-bg)] border-t border-[var(--theme-input-border)] shrink-0">
                <div class="flex items-center space-x-2">
                    <button id="dm-send-photo-btn" class="text-[var(--theme-primary)] text-2xl p-2 h-12 w-12 flex items-center justify-center hover:bg-gray-200 rounded-full"><i class="fas fa-camera"></i></button>
                    <button id="dm-send-audio-btn" class="text-[var(--theme-primary)] text-2xl p-2 h-12 w-12 flex items-center justify-center hover:bg-gray-200 rounded-full"><i class="fas fa-microphone"></i></button>
                    <input id="dm-input" type="text" placeholder="${t('chatPlaceholder')}" class="flex-1 p-3 border border-[var(--theme-input-border)] rounded-full bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" />
                    <button id="dm-send-btn" class="bg-[var(--theme-primary)] text-white rounded-full w-12 h-12 flex items-center justify-center text-xl"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    `;
}


function getProfileViewHTML() {
    const stats = calculateProfileStats();
    const risk = calculateMentalHealthRisk();
    
    const emotionSummaryHTML = EMOTIONS.map(e => {
        const count = stats.emotionCounts[e.name] || 0;
        const percentage = stats.totalEntries > 0 ? ((count / stats.totalEntries) * 100).toFixed(0) : 0;
        return `
            <div class="flex items-center space-x-3">
                <img src="${e.image}" alt="${e.name}" class="w-8 h-8"/>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-[var(--theme-dark-text)]">${e.name}</span>
                        <span class="text-sm font-medium" style="color: var(--theme-text-secondary);">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-[var(--theme-primary)] h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <header class="fixed top-0 left-0 right-0 bg-[var(--theme-header-bg)] text-[var(--theme-header-text)] p-4 flex items-center shadow-md z-20 safe-padding-top">
            <button id="back-from-profile-btn" class="text-2xl w-10"><i class="fas fa-arrow-left"></i></button>
            <h1 class="text-xl font-bold text-center flex-1">${t('profile')}</h1>
            <div class="w-10"></div> <!-- Spacer -->
        </header>
        <main class="pt-16 bg-[var(--theme-light-bg)]">
            <div class="relative">
                <div class="h-32 bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-primary-light)]">
                     <img src="https://picsum.photos/seed/calm-abstract-background/800/200" class="w-full h-full object-cover opacity-50" />
                </div>
                <div class="absolute -bottom-12 left-1/2 -translate-x-1/2">
                    <img src="${userData.avatarImage}" alt="${userData.name}" class="w-24 h-24 rounded-full object-cover border-4 border-[var(--theme-light-bg)] shadow-md"/>
                </div>
            </div>
            
            <div class="pt-16 p-4 text-center">
                <h2 class="text-2xl font-bold text-[var(--theme-dark-text)]">${userData.name}</h2>
                <p style="color: var(--theme-text-secondary);" class="text-sm mb-4">${t('memberSince')} ${new Date(userData.joinDate).toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { year: 'numeric', month: 'long' })}</p>
                <div class="inline-flex items-center px-4 py-1 rounded-full text-sm font-bold shadow-md ${risk.bgColor} ${risk.textColor}">
                    ${risk.level} ${risk.emoji}
                </div>
            </div>

            <div class="px-4 space-y-6 pb-8">
                <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-[var(--theme-dark-text)]">${t('myMottoLabel')}</h3>
                        <button id="edit-bio-btn" class="text-[var(--theme-primary)] text-sm font-semibold">${t('edit')}</button>
                    </div>
                    <p style="color: var(--theme-text-secondary);" class="italic">"${userData.bio}"</p>
                </div>

                <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                    <h3 class="font-semibold text-[var(--theme-dark-text)] mb-4">${t('myStats')}</h3>
                    <div class="flex justify-around text-center">
                        <div class="text-center">
                            <p class="text-3xl font-bold text-[var(--theme-primary)]">${stats.streak} üî•</p>
                            <p class="text-xs" style="color: var(--theme-text-secondary);">${t('currentStreakStat')}</p>
                        </div>
                        <div class="border-l border-[var(--theme-input-border)]"></div>
                        <div class="text-center">
                            <p class="text-3xl font-bold text-[var(--theme-primary)]">${stats.totalEntries}</p>
                            <p class="text-xs" style="color: var(--theme-text-secondary);">${t('daysRegistered')}</p>
                        </div>
                         <div class="border-l border-[var(--theme-input-border)]"></div>
                        <div class="text-center">
                            <p class="text-3xl font-bold text-[var(--theme-primary)]">${stats.mostFrequentEmotion !== 'N/A' ? stats.mostFrequentEmotion.substring(0,3) : '---'}</p>
                            <p class="text-xs" style="color: var(--theme-text-secondary);">${t('freqEmotion')}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md">
                    <h3 class="font-semibold text-[var(--theme-dark-text)] mb-4">${t('moodSummary')}</h3>
                    <div class="space-y-4">
                        ${stats.totalEntries > 0 ? emotionSummaryHTML : `<p class="text-center" style="color: var(--theme-text-secondary);">${t('noRecords')}</p>`}
                    </div>
                </div>

                <div class="bg-[var(--theme-card-bg)] rounded-2xl p-4 shadow-md space-y-1">
                     <h3 class="font-semibold text-[var(--theme-dark-text)] mb-2">${t('mySpace')}</h3>
                     <button id="diary-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100/50 flex items-center text-[var(--theme-dark-text)]"><i class="fas fa-book-open w-6 text-center mr-3" style="color: var(--theme-text-secondary);"></i> ${t('diary.title')}</button>
                     <button id="settings-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100/50 flex items-center text-[var(--theme-dark-text)]"><i class="fas fa-cog w-6 text-center mr-3" style="color: var(--theme-text-secondary);"></i> ${t('settings')}</button>
                     <button id="volunteer-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100/50 flex items-center text-[var(--theme-dark-text)]"><i class="fas fa-hands-helping w-6 text-center mr-3" style="color: var(--theme-text-secondary);"></i> ${t('volunteer')}</button>
                     <button id="donate-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100/50 flex items-center text-[var(--theme-dark-text)]"><i class="fas fa-hand-holding-heart w-6 text-center mr-3" style="color: var(--theme-text-secondary);"></i> ${t('donate')}</button>
                </div>
            </div>
        </main>
    `;
}

// ===================================================================================
// III. EVENT LISTENERS & LOGIC
// ===================================================================================

function attachContentEventListeners() {
    if (currentView === 'dm' && currentDmFriendId) {
        attachDMListeners(currentDmFriendId);
        document.getElementById('back-from-dm-btn').addEventListener('click', () => {
            currentView = 'community';
            currentDmFriendId = null;
            render();
        });
        return;
    }

    const sosBtn = document.getElementById('sos-btn');
    if(sosBtn) sosBtn.addEventListener('click', showSOSModal);

    const profileBtn = document.getElementById('profile-btn');
    if(profileBtn) profileBtn.addEventListener('click', () => { currentView = 'profile'; render(); });

    const logoBtn = document.getElementById('logo-btn');
    if(logoBtn) logoBtn.addEventListener('click', () => { currentView = 'home'; selectedArticle = null; currentDmFriendId = null; render(); });

    const backToHomeBtn = document.querySelector('.back-to-home-btn');
    if(backToHomeBtn) {
        backToHomeBtn.addEventListener('click', () => {
            currentView = 'home';
            selectedArticle = null;
            render();
        });
    }

    if (selectedArticle) {
        document.getElementById('back-to-library-btn').addEventListener('click', () => { selectedArticle = null; render(); });
    } else {
        switch (currentView) {
            case 'home':      attachHomeListeners(); break;
            case 'status':    attachStatusListeners(); break;
            case 'chat':      attachChatListeners(); break;
            case 'mind':      attachMindZoneListeners(); break;
            case 'library':   attachLibraryListeners(); break;
            case 'community': attachCommunityListeners(); break;
        }
    }
}

function attachProfileListeners() {
    document.getElementById('back-from-profile-btn').addEventListener('click', () => {
        currentView = 'home'; // Go back to the main view
        render();
    });
    document.getElementById('diary-btn').addEventListener('click', showDiaryModal);
    document.getElementById('settings-btn').addEventListener('click', showSettingsModal);
    document.getElementById('volunteer-btn').addEventListener('click', showVolunteerModal);
    document.getElementById('donate-btn').addEventListener('click', showDonateModal);
    document.getElementById('edit-bio-btn').addEventListener('click', showEditBioModal);
}

function handleNavigation(event) {
    const view = event.currentTarget.dataset.view;
    if (view) { currentView = view; selectedArticle = null; render(); }
}

function attachHomeListeners() {
    document.querySelectorAll('#view-content .nav-btn').forEach(btn => btn.addEventListener('click', handleNavigation));
}

function attachStatusListeners() {
    document.querySelectorAll('.emotion-btn').forEach(btn => btn.addEventListener('click', (e) => {
        selectedEmotion = e.currentTarget.dataset.emotion;
        const noteValue = document.getElementById('note-input').value;
        document.getElementById('view-content').innerHTML = getStatusViewHTML();
        document.getElementById('note-input').value = noteValue;
        attachStatusListeners();
    }));
    document.getElementById('save-note-btn').addEventListener('click', saveEmotionRecord);
}

function saveEmotionRecord() {
    const noteInput = document.getElementById('note-input');
    if (!selectedEmotion) { showToast(t('pleaseSelectFeeling')); return; }
    const today = new Date().toISOString().split('T')[0];
    const newRecord = { date: today, emotion: selectedEmotion, note: noteInput.value };
    
    const existingRecordToday = userData.emotionHistory.find(r => r.date === today);
    if (!existingRecordToday) {
        userData.streak += 1;
    }
    
    userData.emotionHistory = userData.emotionHistory.filter(r => r.date !== today);
    userData.emotionHistory.push(newRecord);
    
    saveUserData();
    showToast(t('recordSaved'));
    selectedEmotion = null;
    noteInput.value = '';
    currentView = 'home'; // Go to home after saving
    render();
}

function attachChatListeners() {
    const sendBtn = document.getElementById('chat-send-btn');
    const chatInput = document.getElementById('chat-input');
    const sendMessage = () => {
        if (!chatInput.value.trim()) return;
        const userMessage = { id: Date.now(), text: chatInput.value, sender: 'user' };
        userData.chatHistory.push(userMessage);
        const chatResponses = CONTENT[currentLanguage].CHAT_RESPONSES;
        const totusResponse = { id: Date.now() + 1, text: chatResponses[Math.floor(Math.random() * chatResponses.length)], sender: 'totus' };
        chatInput.value = '';
        render();
        setTimeout(() => {
            userData.chatHistory.push(totusResponse);
            saveUserData();
            render();
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 1200);
    };
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function attachDMListeners(friendId) {
    const sendBtn = document.getElementById('dm-send-btn');
    const dmInput = document.getElementById('dm-input');
    const photoBtn = document.getElementById('dm-send-photo-btn');
    const audioBtn = document.getElementById('dm-send-audio-btn');

    const sendMessage = () => {
        const messageText = dmInput.value.trim();
        if (!messageText) return;

        if (!userData.directMessages[friendId]) {
            userData.directMessages[friendId] = [];
        }
        userData.directMessages[friendId].push({ type: 'text', text: messageText, sender: 'user', timestamp: Date.now() });
        dmInput.value = '';
        saveUserData();
        render();

        setTimeout(() => {
            const replies = currentLanguage === 'es' 
                ? ["¬°Entendido!", "Gracias por compartir.", "¬øHay algo m√°s en lo que pueda ayudarte?", "Eso es interesante.", "Te escucho."]
                : ["Got it!", "Thanks for sharing.", "Is there anything else I can help with?", "That's interesting.", "I'm listening."];
            const replyText = replies[Math.floor(Math.random() * replies.length)];
            userData.directMessages[friendId].push({ type: 'text', text: replyText, sender: 'friend', timestamp: Date.now() });
            saveUserData();
            
            if (currentView === 'dm' && currentDmFriendId === friendId) {
                render();
                const messagesContainer = document.getElementById('dm-messages');
                if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }, 1500 + Math.random() * 1000);
    };
    
    const sendMediaMessage = (type) => {
        if (!userData.directMessages[friendId]) {
            userData.directMessages[friendId] = [];
        }
        let message;
        if (type === 'photo') {
            message = {
                type: 'photo',
                url: `https://picsum.photos/seed/${Date.now()}/400/300`,
                sender: 'user',
                timestamp: Date.now()
            };
        } else { // audio
            message = {
                type: 'audio',
                sender: 'user',
                timestamp: Date.now()
            };
        }
        userData.directMessages[friendId].push(message);
        saveUserData();
        render(); 
        const messagesContainer = document.getElementById('dm-messages');
        if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    sendBtn.addEventListener('click', sendMessage);
    dmInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    photoBtn.addEventListener('click', () => sendMediaMessage('photo'));
    audioBtn.addEventListener('click', () => sendMediaMessage('audio'));
    
    const messagesContainer = document.getElementById('dm-messages');
    if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


function attachMindZoneListeners() {
    document.querySelectorAll('.mind-zone-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const sectionId = e.currentTarget.dataset.section;
            const contentEl = document.getElementById('view-content');
            if (sectionId === 'tasks') {
                renderTasksSection();
            } else if (sectionId === 'breathing') {
                contentEl.innerHTML = getBreathingGameHTML();
                startBreathingGame();
            } else if (sectionId === 'exercises') {
                contentEl.innerHTML = getExerciseMenuViewHTML();
                attachExerciseMenuListeners();
            } else if (sectionId === 'games') {
                contentEl.innerHTML = getGamesListHTML();
                attachGamesListListeners();
            } else if (sectionId === 'music') {
                contentEl.innerHTML = getMusicSectionHTML();
                attachMusicListeners();
            } else if (sectionId === 'phrases') {
                contentEl.innerHTML = getPhrasesSectionHTML();
                attachPhrasesListeners();
            }
        });
    });
}

function getTasksSectionHTML() {
    return `
        <div class="p-4">
            <h3 class="text-xl font-bold mb-4 text-center text-[var(--theme-dark-text)]">${t('wellnessTasks')}</h3>
            <div id="tasks-container" class="space-y-3">${getTasksListHTML()}</div>
            <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto mt-8">${t('backToMindZone')}</button>
        </div>`;
}

function getTasksListHTML() {
    if (!userData.dailyTasks || userData.dailyTasks.length === 0) {
        userData.dailyTasks = JSON.parse(JSON.stringify(CONTENT[currentLanguage].INITIAL_DAILY_TASKS));
    }
    return userData.dailyTasks.map(task => `
        <div data-task-id="${task.id}" class="task-item flex items-center p-4 rounded-lg bg-[var(--theme-card-bg)] shadow-sm cursor-pointer">
            <div class="w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-[var(--theme-primary)] border-[var(--theme-primary)]' : 'border-gray-300'} flex items-center justify-center mr-4">
                ${task.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
            </div>
            <span class="text-[var(--theme-dark-text)] ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</span>
        </div>`).join('');
}

function renderTasksSection() {
    document.getElementById('view-content').innerHTML = getTasksSectionHTML();
    attachTasksListeners();
}

function attachTasksListeners() {
    document.getElementById('back-to-mindzone').addEventListener('click', () => renderMindZoneMenu());
    document.querySelectorAll('.task-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const taskId = parseInt(e.currentTarget.dataset.taskId, 10);
            const task = userData.dailyTasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveUserData();
                renderTasksSection(); // Re-render the whole view for simplicity and robustness
            }
        });
    });
}

function renderMindZoneMenu() { currentView = 'mind'; render(); }

// ----- Exercises -----
function getExerciseMenuViewHTML() {
    const exerciseTypes = [
        { id: 'yoga', name: t('yoga'), icon: 'fa-om' },
        { id: 'weights', name: t('weights'), icon: 'fa-dumbbell' },
        { id: 'running', name: t('running'), icon: 'fa-person-running' },
        { id: 'stretching', name: t('stretching'), icon: 'fa-child-reaching' }
    ];
    return `
        <div class="p-4">
            <button id="back-to-mindzone" class="mb-4 text-[var(--theme-primary)] font-semibold"><i class="fas fa-arrow-left mr-2"></i> ${t('backToMindZone')}</button>
            <h3 class="text-2xl font-bold mb-4 text-center text-[var(--theme-dark-text)]">${t('exerciseCenter')}</h3>
            <p class="text-center mb-6" style="color: var(--theme-text-secondary);">${t('chooseActivity')}</p>
            <div class="grid grid-cols-2 gap-4">
                ${exerciseTypes.map(ex => `
                    <button data-exercise-type="${ex.id}" class="exercise-type-btn flex flex-col items-center justify-center bg-[var(--theme-card-bg)] rounded-2xl shadow-md p-4 text-center transition-transform transform hover:scale-105 aspect-square">
                        <i class="fas ${ex.icon} text-4xl mb-3 text-[var(--theme-primary)]"></i>
                        <p class="font-bold text-base text-[var(--theme-primary)]">${ex.name}</p>
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

function attachExerciseMenuListeners() {
    document.getElementById('back-to-mindzone').addEventListener('click', () => renderMindZoneMenu());
    document.querySelectorAll('.exercise-type-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const type = e.currentTarget.dataset.exerciseType;
            if (type === 'stretching') {
                startExerciseRoutine();
            } else if (type === 'yoga') {
                startYogaRoutine();
            } else if (type === 'weights') {
                startWeightsRoutine();
            } else if (type === 'running') {
                startRunningRoutine();
            }
        });
    });
}

function startYogaRoutine() {
    let currentPoseIndex = 0;
    let timer;
    const YOGA_ROUTINE = CONTENT[currentLanguage].YOGA_ROUTINE;
    const viewContentEl = document.getElementById('view-content');

    const showFinishedScreen = () => {
        viewContentEl.innerHTML = `
            <div class="p-4 text-center flex flex-col items-center justify-center bg-teal-50" style="height: calc(100vh - 100px);">
                <i class="fas fa-check-circle text-6xl text-teal-500 mb-4"></i>
                <h4 class="text-2xl font-bold text-teal-600">${t('yogaComplete')}</h4>
                <p class="mt-2 text-gray-600">${t('yogaCompleteSub')}</p>
                <button id="back-to-exercises-finish" class="mt-8 bg-primary text-white font-bold py-3 px-8 rounded-lg">${t('backToExercises')}</button>
            </div>
        `;
        document.getElementById('back-to-exercises-finish').addEventListener('click', () => {
            viewContentEl.innerHTML = getExerciseMenuViewHTML();
            attachExerciseMenuListeners();
        });
    };

    function showPose() {
        if (!viewContentEl) return;
        const pose = YOGA_ROUTINE[currentPoseIndex];
        let timeLeft = pose.duration;
        const radius = 75;
        const circumference = 2 * Math.PI * radius;

        viewContentEl.innerHTML = `
            <div class="relative p-4 text-center flex flex-col items-center justify-between bg-cover bg-center text-white" style="height: calc(100vh - 100px); background-image: url('https://images.unsplash.com/photo-1506126613408-eca07ce68773?q=80&w=1999&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                <div class="relative z-10"><!-- Spacer --></div>
                <div class="relative z-10">
                    <h4 class="text-2xl font-bold text-white mb-2">${pose.name}</h4>
                    <div class="relative w-48 h-48 mb-6">
                        <img src="${pose.image}" class="w-full h-full object-cover rounded-full shadow-lg" />
                        <svg class="absolute inset-0" width="192" height="192" viewBox="0 0 160 160">
                            <circle class="text-white/30" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="80" cy="80" />
                            <circle
                                class="text-teal-400 progress-ring__circle" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent"
                                r="${radius}" cx="80" cy="80"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference}; animation: progress-anim ${pose.duration}s linear forwards;"
                            />
                        </svg>
                        <div id="exercise-timer" class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-white">${timeLeft}</div>
                    </div>
                    <p class="text-white mt-4 max-w-xs">${pose.description}</p>
                </div>
                <button id="exit-exercise-btn" class="relative z-10 text-white font-semibold mb-4">${t('exitRoutine')}</button>
            </div>
            <style>@keyframes progress-anim { from { stroke-dashoffset: ${circumference}; } to { stroke-dashoffset: 0; } }</style>`;
        
        document.getElementById('exit-exercise-btn').addEventListener('click', () => {
            clearInterval(timer);
            viewContentEl.innerHTML = getExerciseMenuViewHTML();
            attachExerciseMenuListeners();
        });

        timer = setInterval(() => {
            timeLeft--;
            const timerEl = document.getElementById('exercise-timer');
            if (timerEl) timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                currentPoseIndex++;
                if (currentPoseIndex < YOGA_ROUTINE.length) {
                    showPose();
                } else {
                    showFinishedScreen();
                }
            }
        }, 1000);
    }
    showPose();
}

function startWeightsRoutine() {
    let currentExerciseIndex = 0;
    let currentSet = 1;
    let restTimer;
    const WEIGHTS_ROUTINE = CONTENT[currentLanguage].WEIGHTS_ROUTINE;
    const viewContentEl = document.getElementById('view-content');
    const REST_DURATION = 60; // seconds

    const showFinishedScreen = () => {
        clearInterval(restTimer);
        viewContentEl.innerHTML = `
            <div class="p-4 text-center flex flex-col items-center justify-center bg-slate-800 text-white" style="height: calc(100vh - 100px);">
                <i class="fas fa-trophy text-6xl text-accent-yellow mb-4"></i>
                <h4 class="text-2xl font-bold text-white">${t('trainingComplete')}</h4>
                <p class="mt-2 text-slate-400">${t('trainingCompleteSub')}</p>
                <button id="back-to-exercises-finish" class="mt-8 bg-accent-yellow text-primary font-bold py-3 px-8 rounded-lg">${t('backToExercises')}</button>
            </div>
        `;
        document.getElementById('back-to-exercises-finish').addEventListener('click', () => {
            viewContentEl.innerHTML = getExerciseMenuViewHTML();
            attachExerciseMenuListeners();
        });
    };

    const showRestScreen = () => {
        clearInterval(restTimer);
        let timeLeft = REST_DURATION;
        const nextExercise = WEIGHTS_ROUTINE[currentExerciseIndex];
        const radius = 75;
        const circumference = 2 * Math.PI * radius;

        viewContentEl.innerHTML = `
            <div class="p-4 text-center flex flex-col items-center justify-around bg-slate-800 text-white" style="height: calc(100vh - 90px);">
                <div>
                    <h4 class="text-2xl font-bold">${t('rest')}</h4>
                    <p class="text-slate-400">${t('prepareForNextSet')}</p>
                </div>
                <div class="relative w-48 h-48 my-4">
                    <svg class="absolute inset-0" width="192" height="192" viewBox="0 0 160 160">
                        <circle class="text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="80" cy="80" />
                        <circle
                            class="text-accent-yellow progress-ring__circle" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent"
                            r="${radius}" cx="80" cy="80"
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference}; animation: progress-anim ${REST_DURATION}s linear forwards;"
                        />
                    </svg>
                    <div id="rest-timer" class="absolute inset-0 flex items-center justify-center text-4xl font-bold">${timeLeft}</div>
                </div>
                <div>
                    <p class="text-slate-400">${t('nextExercise')}</p>
                    <p class="font-bold text-xl">${nextExercise.name} - ${nextExercise.reps} ${t('reps')}</p>
                </div>
                <button id="skip-rest-btn" class="text-accent-yellow font-semibold mt-4">${t('skipRest')}</button>
            </div>
            <style>@keyframes progress-anim { from { stroke-dashoffset: ${circumference}; } to { stroke-dashoffset: 0; } }</style>`;
        
        const skipBtn = viewContentEl.querySelector('#skip-rest-btn');
        skipBtn.addEventListener('click', () => {
            clearInterval(restTimer);
            showExercise();
        });

        restTimer = setInterval(() => {
            timeLeft--;
            const timerEl = document.getElementById('rest-timer');
            if (timerEl) timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(restTimer);
                showExercise();
            }
        }, 1000);
    };

    const showExercise = () => {
        clearInterval(restTimer); // Ensure no rest timer is running
        const exercise = WEIGHTS_ROUTINE[currentExerciseIndex];
        viewContentEl.innerHTML = `
            <div class="p-4 text-center flex flex-col justify-around bg-slate-800 text-white" style="height: calc(100vh - 90px);">
                <div>
                    <h3 class="text-2xl font-bold">${exercise.name}</h3>
                    <p class="text-slate-400">SERIE ${currentSet} DE ${exercise.sets}</p>
                </div>
                <img src="${exercise.image}" class="rounded-2xl shadow-lg mx-auto my-2 w-full max-w-xs h-48 object-cover"/>
                <div>
                    <p class="text-7xl font-bold text-accent-yellow">${exercise.reps}</p>
                    <p class="text-xl">Repeticiones</p>
                </div>
                <div>
                    <button id="complete-set-btn" class="mt-4 bg-accent-yellow text-primary font-bold py-3 px-8 rounded-lg w-full">${t('completeSet')}</button>
                </div>
                <button id="exit-exercise-btn" class="text-slate-400 font-semibold mt-2">${t('finishTraining')}</button>
            </div>`;

        viewContentEl.querySelector('#exit-exercise-btn').addEventListener('click', () => {
            clearInterval(restTimer);
            viewContentEl.innerHTML = getExerciseMenuViewHTML();
            attachExerciseMenuListeners();
        });

        viewContentEl.querySelector('#complete-set-btn').addEventListener('click', () => {
            if (currentSet < exercise.sets) {
                currentSet++;
                showRestScreen();
            } else {
                currentSet = 1;
                currentExerciseIndex++;
                if (currentExerciseIndex < WEIGHTS_ROUTINE.length) {
                    showToast(t('nextExercise'));
                    showExercise();
                } else {
                    showFinishedScreen();
                }
            }
        });
    };
    
    showExercise();
}

function startRunningRoutine() {
    let timerInterval = null;
    let startTime = 0;
    let elapsedTime = 0;
    let isRunning = false;
    const viewContentEl = document.getElementById('view-content');

    const formatTime = (ms) => {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    };

    const updateUI = () => {
        const distance = (elapsedTime / 1000 / (7 * 60)) * 1.0; // Simulate 7 min/km pace
        const pace = elapsedTime > 1000 ? formatTime(elapsedTime / distance) : '00:00';
        
        if(viewContentEl.querySelector('#run-time')) viewContentEl.querySelector('#run-time').textContent = formatTime(elapsedTime);
        if(viewContentEl.querySelector('#run-distance')) viewContentEl.querySelector('#run-distance').textContent = distance.toFixed(2) + ' KM';
        if(viewContentEl.querySelector('#run-pace')) viewContentEl.querySelector('#run-pace').textContent = pace;
    };

    const startTimer = () => {
        if (isRunning) return;
        isRunning = true;
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(() => {
            elapsedTime = Date.now() - startTime;
            updateUI();
        }, 100);
        viewContentEl.querySelector('#run-control-btn').innerHTML = `<i class="fas fa-pause"></i> ${t('pause')}`;
    };

    const pauseTimer = () => {
        if (!isRunning) return;
        isRunning = false;
        clearInterval(timerInterval);
        viewContentEl.querySelector('#run-control-btn').innerHTML = `<i class="fas fa-play"></i> ${t('continue')}`;
    };
    
    viewContentEl.innerHTML = `
    <div class="relative p-4 text-center flex flex-col justify-between bg-cover bg-center text-white" style="height: calc(100vh - 90px); background-image: url('https://plus.unsplash.com/premium_photo-1674605365723-15e6749630f4?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative z-10">
            <h3 class="text-2xl font-bold">${t('runningSession')}</h3>
            <p id="run-time" class="text-7xl font-bold my-4">00:00</p>
        </div>
        
        <div class="relative z-10 grid grid-cols-3 gap-4 my-4 bg-black/30 p-4 rounded-xl">
            <div><p id="run-distance" class="font-bold text-2xl">0.00 KM</p><p class="text-sm opacity-80">${t('distance')}</p></div>
            <div><p id="run-pace" class="font-bold text-2xl">00:00</p><p class="text-sm opacity-80">${t('pace')}</p></div>
            <div><p class="font-bold text-2xl">75</p><p class="text-sm opacity-80">${t('calories')}</p></div>
        </div>
        <div class="relative z-10 flex space-x-4">
            <button id="run-control-btn" class="flex-1 bg-white/90 text-primary font-bold py-3 rounded-lg backdrop-blur-sm"><i class="fas fa-play"></i> ${t('start')}</button>
            <button id="exit-exercise-btn" class="w-1/3 bg-red-500/90 text-white font-bold py-3 rounded-lg backdrop-blur-sm"><i class="fas fa-stop"></i> ${t('finishRun')}</button>
        </div>
    </div>
    `;

    viewContentEl.querySelector('#run-control-btn').addEventListener('click', () => {
        if (isRunning) {
            pauseTimer();
        } else {
            startTimer();
        }
    });

    viewContentEl.querySelector('#exit-exercise-btn').addEventListener('click', () => {
        clearInterval(timerInterval);
        viewContentEl.innerHTML = getExerciseMenuViewHTML();
        attachExerciseMenuListeners();
    });
}


function startExerciseRoutine() {
    let currentExerciseIndex = 0;
    let timer;
    const STRETCH_ROUTINE = CONTENT[currentLanguage].STRETCH_ROUTINE;
    const viewContentEl = document.getElementById('view-content');

    function showExercise() {
        if (!viewContentEl) return;
        const exercise = STRETCH_ROUTINE[currentExerciseIndex];
        let timeLeft = exercise.duration;
        
        const radius = 75;
        const circumference = 2 * Math.PI * radius;

        viewContentEl.innerHTML = `
            <div class="relative p-4 text-center flex flex-col items-center justify-between bg-cover bg-center text-white" style="height: calc(100vh - 100px); background-image: url('https://images.unsplash.com/photo-1545205597-3d9d02c29597?q=80&w=1974&auto=format&fit=crop');">
                 <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                <div class="relative z-10"><!-- Top content spacer --></div>
                <div class="relative z-10">
                    <div class="relative w-48 h-48 mb-6">
                        <img src="${exercise.image}" class="w-full h-full object-cover rounded-full shadow-lg" />
                        <svg class="absolute inset-0" width="192" height="192" viewBox="0 0 160 160">
                            <circle class="text-white/30" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="80" cy="80" />
                            <circle
                                class="text-accent-lila progress-ring__circle"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke="currentColor"
                                fill="transparent"
                                r="${radius}"
                                cx="80"
                                cy="80"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference};"
                            />
                        </svg>
                        <div id="exercise-timer" class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-white">${timeLeft}</div>
                    </div>
                    <h4 class="text-2xl font-bold text-white">${exercise.name}</h4>
                    <p class="my-2 max-w-xs text-white">${exercise.description}</p>
                </div>
                <button id="exit-exercise-btn" class="relative z-10 text-white font-semibold mb-4">${t('exitRoutine')}</button>
            </div>
            <style>@keyframes progress-anim { from { stroke-dashoffset: ${circumference}; } to { stroke-dashoffset: 0; } }</style>
        `;
        
        document.getElementById('exit-exercise-btn').addEventListener('click', () => {
            clearInterval(timer);
            viewContentEl.innerHTML = getExerciseMenuViewHTML();
            attachExerciseMenuListeners();
        });

        const progressCircle = viewContentEl.querySelector('.progress-ring__circle');
        if(progressCircle) {
             progressCircle.style.animation = `progress-anim ${exercise.duration}s linear forwards`;
        }

        timer = setInterval(() => {
            timeLeft--;
            const timerEl = document.getElementById('exercise-timer');
            if (timerEl) timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                currentExerciseIndex++;
                if (currentExerciseIndex < STRETCH_ROUTINE.length) {
                    showExercise();
                } else {
                    viewContentEl.innerHTML = `
                        <div class="p-4 text-center flex flex-col items-center justify-center" style="height: calc(100vh - 100px);">
                            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                            <h4 class="text-2xl font-bold text-green-500">${t('routineComplete')}</h4>
                            <p class="mt-2" style="color: var(--theme-text-secondary);">${t('routineCompleteSub')}</p>
                            <button id="back-to-exercises-finish" class="mt-8 bg-primary text-white font-bold py-3 px-8 rounded-lg">${t('backToExercises')}</button>
                        </div>
                    `;
                    document.getElementById('back-to-exercises-finish').addEventListener('click', () => {
                        viewContentEl.innerHTML = getExerciseMenuViewHTML();
                        attachExerciseMenuListeners();
                    });
                }
            }
        }, 1000);
    }
    showExercise();
}

// ----- Music -----
function getMusicSectionHTML() {
    const RELAXING_SOUNDS = CONTENT[currentLanguage].RELAXING_SOUNDS;
    const playerStatus = currentMusic.track ? `${t('sounding')}: ${currentMusic.track.name}` : t('selectSound');
    const playIcon = currentMusic.isPlaying ? 'fa-pause' : 'fa-play';
    const bgImageStyle = currentMusic.track ? `style="background-image: url('${currentMusic.track.image}');"` : 'style="background-color: var(--theme-light-bg);"';
    const textClass = currentMusic.track ? 'text-white' : 'text-[var(--theme-primary)]';

    let displayedSounds = RELAXING_SOUNDS;
    if (musicState.currentTab === 'favorites') {
        displayedSounds = RELAXING_SOUNDS.filter(s => userData.musicFavorites.includes(s.id));
    } else if (musicState.currentTab === 'playlist') {
        displayedSounds = RELAXING_SOUNDS.filter(s => userData.musicPlaylist.includes(s.id));
    }

    if (musicState.searchTerm) {
        displayedSounds = displayedSounds.filter(s => s.name.toLowerCase().includes(musicState.searchTerm.toLowerCase()));
    }

    const soundListHTML = displayedSounds.length > 0 ? displayedSounds.map(sound => {
        const isFavorite = userData.musicFavorites.includes(sound.id);
        const isInPlaylist = userData.musicPlaylist.includes(sound.id);
        return `
            <div class="bg-[var(--theme-card-bg)] p-3 rounded-xl shadow-sm text-center flex flex-col justify-between">
                <button data-track-id="${sound.id}" class="music-track-btn w-full">
                    <i class="fas ${sound.icon} text-[var(--theme-primary)] text-2xl mb-2"></i>
                    <p class="font-semibold text-[var(--theme-dark-text)] text-xs leading-tight">${sound.name}</p>
                </button>
                <div class="flex justify-center items-center space-x-3 mt-2 pt-2 border-t border-[var(--theme-input-border)]">
                    <button data-track-id="${sound.id}" class="toggle-favorite-btn text-gray-400 hover:text-red-500 ${isFavorite ? 'text-red-500' : ''}">
                        <i class="fa-${isFavorite ? 'solid' : 'regular'} fa-heart"></i>
                    </button>
                    <button data-track-id="${sound.id}" class="toggle-playlist-btn text-gray-400 hover:text-primary ${isInPlaylist ? 'text-primary' : ''}">
                         <i class="fa-${isInPlaylist ? 'solid' : 'minus'} fa-plus"></i>
                    </button>
                </div>
            </div>`;
    }).join('') : `<p class="col-span-4 text-center py-4" style="color: var(--theme-text-secondary);">${t('noSoundsFound')}</p>`;

    return `
        <div class="p-4">
            <h3 class="text-xl font-bold mb-4 text-center text-[var(--theme-dark-text)]">${t('relaxingMusic')}</h3>
            <div id="music-player-card" class="rounded-2xl shadow-md p-4 mb-4 bg-cover bg-center transition-all duration-500" ${bgImageStyle}>
                <div class="bg-black bg-opacity-40 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p id="player-status" class="font-semibold ${textClass} transition-colors">${playerStatus}</p>
                            <div id="music-visualizer" class="flex items-end h-6 space-x-1 mt-2 ${currentMusic.isPlaying ? '' : 'hidden'}">
                                <div class="w-1 bg-white visualizer-bar" style="animation-delay: 0.1s;"></div>
                                <div class="w-1 bg-white visualizer-bar" style="animation-delay: 0.3s;"></div>
                                <div class="w-1 bg-white visualizer-bar" style="animation-delay: 0.2s;"></div>
                                <div class="w-1 bg-white visualizer-bar" style="animation-delay: 0.4s;"></div>
                            </div>
                        </div>
                        <button id="play-pause-btn" class="${textClass} text-2xl w-12 h-12 rounded-full flex items-center justify-center hover:bg-white hover:bg-opacity-20 transition-colors ${!currentMusic.track ? 'opacity-50 cursor-not-allowed' : ''}" ${!currentMusic.track ? 'disabled' : ''}>
                            <i class="fas ${playIcon}"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="relative mb-4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search" style="color: var(--theme-text-secondary);"></i></span>
                <input id="music-search-input" type="text" placeholder="${t('searchSounds')}" class="w-full p-2 pl-10 border border-[var(--theme-input-border)] rounded-lg bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" value="${musicState.searchTerm}">
            </div>

            <div class="flex justify-center items-center mb-4 rounded-lg bg-gray-200 p-1">
                <button data-tab="all" class="music-tab-btn flex-1 py-1 rounded-md text-sm font-semibold ${musicState.currentTab === 'all' ? 'bg-white text-primary shadow' : 'text-gray-600'}">${t('all')}</button>
                <button data-tab="favorites" class="music-tab-btn flex-1 py-1 rounded-md text-sm font-semibold ${musicState.currentTab === 'favorites' ? 'bg-white text-primary shadow' : 'text-gray-600'}">${t('favorites')}</button>
                <button data-tab="playlist" class="music-tab-btn flex-1 py-1 rounded-md text-sm font-semibold ${musicState.currentTab === 'playlist' ? 'bg-white text-primary shadow' : 'text-gray-600'}">${t('myList')}</button>
            </div>

            <div class="grid grid-cols-3 gap-3">${soundListHTML}</div>
            <button id="back-to-mindzone" class="text-primary font-semibold block mx-auto mt-6">${t('backToMindZone')}</button>
        </div>`;
}

function attachMusicListeners() {
    const RELAXING_SOUNDS = CONTENT[currentLanguage].RELAXING_SOUNDS;
    function updateMusicView() {
        const contentEl = document.getElementById('view-content');
        if (contentEl && currentView === 'mind') {
            contentEl.innerHTML = getMusicSectionHTML();
            attachMusicListeners();
        }
    }
    
    document.getElementById('back-to-mindzone').addEventListener('click', () => {
        currentMusic = { track: null, isPlaying: false };
        musicState = { currentTab: 'all', searchTerm: '' };
        renderMindZoneMenu();
    });

    document.querySelectorAll('.music-track-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const trackId = parseInt(e.currentTarget.dataset.trackId, 10);
            const selectedTrack = RELAXING_SOUNDS.find(t => t.id === trackId);
            if (currentMusic.track && currentMusic.track.id === selectedTrack.id) {
                currentMusic.isPlaying = !currentMusic.isPlaying;
            } else {
                currentMusic.track = selectedTrack;
                currentMusic.isPlaying = true;
            }
            updateMusicView();
        });
    });

    const playPauseBtn = document.getElementById('play-pause-btn');
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', () => {
            if (currentMusic.track) {
                currentMusic.isPlaying = !currentMusic.isPlaying;
                updateMusicView();
            }
        });
    }

    document.getElementById('music-search-input').addEventListener('input', e => {
        musicState.searchTerm = e.target.value;
        updateMusicView();
    });
    
    document.querySelectorAll('.music-tab-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            musicState.currentTab = e.currentTarget.dataset.tab;
            updateMusicView();
        });
    });

    document.querySelectorAll('.toggle-favorite-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const trackId = parseInt(e.currentTarget.dataset.trackId, 10);
            const index = userData.musicFavorites.indexOf(trackId);
            if (index > -1) {
                userData.musicFavorites.splice(index, 1);
            } else {
                userData.musicFavorites.push(trackId);
            }
            saveUserData();
            updateMusicView();
        });
    });

    document.querySelectorAll('.toggle-playlist-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const trackId = parseInt(e.currentTarget.dataset.trackId, 10);
            const index = userData.musicPlaylist.indexOf(trackId);
            if (index > -1) {
                userData.musicPlaylist.splice(index, 1);
            } else {
                userData.musicPlaylist.push(trackId);
            }
            saveUserData();
            updateMusicView();
        });
    });
}


// ----- Phrases -----
function getPhrasesSectionHTML() {
    return `
        <div class="p-4 text-center flex flex-col" style="height: calc(100vh - 150px);">
            <h3 class="text-xl font-bold mb-4 text-[var(--theme-dark-text)] shrink-0">${t('encouragingPhrases')}</h3>
            <div class="flex-1 flex items-center justify-center">
                <div class="bg-[var(--theme-card-bg)] rounded-2xl shadow-md p-6 fade-in">
                    <p id="phrase-text" class="text-2xl font-semibold text-[var(--theme-primary)]">"${currentPhrase}"</p>
                </div>
            </div>
            <div class="shrink-0 mt-6">
                <button id="new-phrase-btn" class="bg-[var(--theme-primary)] text-white font-bold py-3 px-6 rounded-lg mb-4">${t('showAnotherPhrase')}</button>
                <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto">${t('backToMindZone')}</button>
            </div>
        </div>
    `;
}

function attachPhrasesListeners() {
    const ENCOURAGING_PHRASES = CONTENT[currentLanguage].ENCOURAGING_PHRASES;
    document.getElementById('back-to-mindzone').addEventListener('click', () => renderMindZoneMenu());

    document.getElementById('new-phrase-btn').addEventListener('click', () => {
        let newPhrase;
        do {
            newPhrase = ENCOURAGING_PHRASES[Math.floor(Math.random() * ENCOURAGING_PHRASES.length)];
        } while (newPhrase === currentPhrase);
        currentPhrase = newPhrase;
        
        const phraseContainer = document.getElementById('phrase-text').parentElement;
        const phraseTextEl = document.getElementById('phrase-text');
        
        phraseContainer.classList.remove('fade-in');
        void phraseContainer.offsetWidth; // Trigger reflow
        phraseContainer.classList.add('fade-in');
        phraseTextEl.textContent = `"${currentPhrase}"`;
    });
}


// ----- GAMES -----
function attachGamesListListeners() {
    document.getElementById('back-to-mindzone').addEventListener('click', () => renderMindZoneMenu());
    document.querySelectorAll('.game-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const gameId = e.currentTarget.dataset.game;
            const contentEl = document.getElementById('view-content');
            if (gameId === 'colorMatch') {
                contentEl.innerHTML = getColorMatchGameHTML();
                startColorMatchGame();
            } else if (gameId === 'reactionTime') {
                contentEl.innerHTML = getReactionTimeGameHTML();
                startReactionTimeGame();
            } else if (gameId === 'memoryGame') {
                contentEl.innerHTML = getMemoryGameHTML();
                startMemoryGame();
            }
        });
    });
}

function getGamesListHTML() {
    const games = [
        { id: 'colorMatch', label: 'Memoria de Colores', icon: 'fa-palette', color: 'text-green-500' },
        { id: 'reactionTime', label: t('reactionTest'), icon: 'fa-bolt', color: 'text-accent-coral' },
        { id: 'memoryGame', label: t('memoryGame'), icon: 'fa-brain', color: 'text-purple-500' }
    ];
    return `
        <div class="p-4">
            <h3 class="text-xl font-bold mb-4 text-center text-[var(--theme-dark-text)]">${t('relaxingGames')}</h3>
            <div class="space-y-3">${games.map(g => `<button data-game="${g.id}" class="game-btn w-full flex items-center p-4 rounded-lg bg-[var(--theme-card-bg)] shadow-sm"><i class="fas ${g.icon} ${g.color} text-2xl w-8 text-center mr-4"></i><span class="font-semibold text-[var(--theme-dark-text)]">${g.label}</span></button>`).join('')}</div>
            <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto mt-8">${t('backToMindZone')}</button>
        </div>`;
}

function getBreathingGameHTML() {
    return `
        <div class="p-4 text-center">
            <h3 class="text-xl font-bold mb-2 text-[var(--theme-dark-text)]">${t('guidedBreathing')}</h3>
            <p id="breathing-instruction" class="text-2xl font-semibold text-primary h-8 mb-4">${t('getReady')}</p>
            <div class="relative w-48 h-48 mx-auto">
                <div id="breathing-circle" class="absolute inset-0 bg-accent-lila rounded-full opacity-70 transition-transform duration-[4000ms] ease-in-out"></div>
            </div>
            <button id="back-to-mindzone" class="text-primary font-semibold block mx-auto mt-8">${t('backToMindZone')}</button>
        </div>`;
}

function startBreathingGame() {
    let cycleTimeout;
    const backBtn = document.getElementById('back-to-mindzone');
    const instructionEl = document.getElementById('breathing-instruction');
    const circleEl = document.getElementById('breathing-circle');
    
    backBtn.addEventListener('click', () => { 
        clearTimeout(cycleTimeout);
        renderMindZoneMenu();
    });

    const cycle = [
        { text: t('breatheIn'), duration: 4000, scale: 1.1 },
        { text: t('hold'), duration: 7000, scale: 1.1 },
        { text: t('breatheOut'), duration: 8000, scale: 0.8 },
    ];
    let currentIndex = 0;
    
    function runCycle() {
        const step = cycle[currentIndex];
        if (instructionEl) instructionEl.textContent = step.text;
        if (circleEl) circleEl.style.transform = `scale(${step.scale})`;
        currentIndex = (currentIndex + 1) % cycle.length;
        cycleTimeout = setTimeout(runCycle, step.duration);
    }
    
    cycleTimeout = setTimeout(runCycle, 1000);
}

function getColorMatchGameHTML() {
    return `
        <div class="p-4">
            <div class="flex justify-between items-center mb-4 p-2 bg-[var(--theme-card-bg)] rounded-lg shadow-sm text-[var(--theme-dark-text)]">
                <div>${t('level')}: <span id="cm-score" class="font-bold text-[var(--theme-primary)] text-lg">0</span></div>
                <div>${t('best')}: <span id="cm-highscore" class="font-bold text-[var(--theme-primary)] text-lg">${userData.gameScores.colorMatch}</span></div>
            </div>
            <div class="relative aspect-square max-w-sm mx-auto grid grid-cols-2 gap-3">
                <button data-color="green" class="color-match-btn bg-green-500 rounded-lg"></button>
                <button data-color="red" class="color-match-btn bg-red-500 rounded-lg"></button>
                <button data-color="yellow" class="color-match-btn bg-yellow-400 rounded-lg"></button>
                <button data-color="blue" class="color-match-btn bg-blue-500 rounded-lg"></button>
                <div id="cm-status-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-lg">
                    <button id="start-cm-game" class="bg-primary text-white font-bold py-3 px-6 rounded-lg">${t('start')}</button>
                </div>
            </div>
            <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto mt-8">${t('backToMindZone')}</button>
        </div>`;
}

function startColorMatchGame() {
    document.getElementById('back-to-mindzone').addEventListener('click', renderMindZoneMenu);

    const startBtn = document.getElementById('start-cm-game');
    const statusOverlay = document.getElementById('cm-status-overlay');
    const scoreEl = document.getElementById('cm-score');
    const buttons = document.querySelectorAll('.color-match-btn');
    
    let sequence = [];
    let playerSequence = [];
    let level = 0;
    let canPlayerClick = false;

    const colors = ['green', 'red', 'yellow', 'blue'];

    function nextLevel() {
        level++;
        scoreEl.textContent = level;
        playerSequence = [];
        canPlayerClick = false;
        sequence.push(colors[Math.floor(Math.random() * colors.length)]);
        playSequence();
    }

    function playSequence() {
        let i = 0;
        const interval = setInterval(() => {
            flashButton(sequence[i]);
            i++;
            if (i >= sequence.length) {
                clearInterval(interval);
                canPlayerClick = true;
            }
        }, 800);
    }

    function flashButton(color) {
        const button = document.querySelector(`.color-match-btn[data-color="${color}"]`);
        button.classList.add('flash');
        setTimeout(() => button.classList.remove('flash'), 400);
    }

    function handlePlayerClick(e) {
        if (!canPlayerClick) return;
        const clickedColor = e.target.dataset.color;
        flashButton(clickedColor);
        playerSequence.push(clickedColor);
        
        if (playerSequence[playerSequence.length - 1] !== sequence[playerSequence.length - 1]) {
            gameOver();
            return;
        }

        if (playerSequence.length === sequence.length) {
            canPlayerClick = false;
            setTimeout(nextLevel, 1000);
        }
    }

    function gameOver() {
        canPlayerClick = false;
        if (level > userData.gameScores.colorMatch) {
            userData.gameScores.colorMatch = level;
            saveUserData();
        }
        statusOverlay.innerHTML = `<div class="text-center"><p class="font-bold text-xl text-white">${t('gameOver')}<br>${t('level')}: ${level}</p><button id="restart-cm-game" class="mt-4 bg-primary text-white font-bold py-2 px-4 rounded-lg">${t('playAgain')}</button></div>`;
        statusOverlay.style.display = 'flex';
        document.getElementById('restart-cm-game').addEventListener('click', startGame);
    }

    function startGame() {
        sequence = [];
        level = 0;
        scoreEl.textContent = 0;
        statusOverlay.style.display = 'none';
        setTimeout(nextLevel, 500);
    }

    startBtn.addEventListener('click', () => {
        startGame();
    });
    buttons.forEach(btn => btn.addEventListener('click', handlePlayerClick));
}


function getReactionTimeGameHTML() {
    return `
        <div class="p-4 flex flex-col h-full">
            <div class="flex justify-between items-center mb-4 p-2 bg-[var(--theme-card-bg)] rounded-lg shadow-sm text-[var(--theme-dark-text)]">
                <div>${t('time')}: <span id="rt-score" class="font-bold text-[var(--theme-primary)] text-lg">--</span> ms</div>
                <div>${t('best')}: <span id="rt-highscore" class="font-bold text-[var(--theme-primary)] text-lg">${userData.gameScores.reactionTime === 9999 ? '--' : userData.gameScores.reactionTime}</span> ms</div>
            </div>
            <div id="rt-area" class="flex-1 flex items-center justify-center text-center rounded-lg bg-red-500 text-white p-4 cursor-pointer">
                <h3 id="rt-message" class="text-3xl font-bold">${t('clickToStart')}<br/>${t('whenGreenClickAgain')}</h3>
            </div>
            <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto mt-4 shrink-0">${t('backToMindZone')}</button>
        </div>`;
}

function startReactionTimeGame() {
    let timer;
    document.getElementById('back-to-mindzone').addEventListener('click', () => {
        clearTimeout(timer);
        renderMindZoneMenu();
    });

    const area = document.getElementById('rt-area');
    const message = document.getElementById('rt-message');
    const scoreEl = document.getElementById('rt-score');
    
    let startTime;
    
    let waitingForClick = false;

    function startGame() {
        area.classList.remove('bg-green-500');
        area.classList.add('bg-red-500');
        message.innerHTML = t('waitForGreen');
        waitingForClick = false;

        timer = setTimeout(() => {
            area.classList.remove('bg-red-500');
            area.classList.add('bg-green-500');
            message.innerHTML = t('now');
            startTime = Date.now();
            waitingForClick = true;
        }, Math.random() * 3000 + 1500);
    }
    
    area.addEventListener('click', () => {
        if (waitingForClick) { // Clicked on green
            const reactionTime = Date.now() - startTime;
            scoreEl.textContent = reactionTime;
            if (reactionTime < userData.gameScores.reactionTime) {
                userData.gameScores.reactionTime = reactionTime;
                saveUserData();
            }
            message.innerHTML = `${t('yourTime')}: ${reactionTime} ms.<br/>${t('tryAgain')}`;
            waitingForClick = false;
        } else if (timer) { // Clicked too soon
            clearTimeout(timer);
            message.innerHTML = `${t('tooSoon')}<br/>${t('tryAgain')}`;
            timer = null;
        } else { // Clicked to start/restart
            startGame();
        }
    });
}

function getMemoryGameHTML() {
    return `
        <div class="p-4">
            <h3 class="text-xl font-bold mb-2 text-center text-[var(--theme-dark-text)]">${t('memoryGame')}</h3>
            <p class="text-center mb-4 text-[var(--theme-dark-text)]">${t('moves')}: <span id="memory-moves" class="font-bold text-[var(--theme-primary)] text-lg">0</span></p>
            <div id="memory-grid" class="grid grid-cols-4 gap-3 aspect-square max-w-sm mx-auto"></div>
            <button id="back-to-mindzone" class="text-[var(--theme-primary)] font-semibold block mx-auto mt-8">${t('backToMindZone')}</button>
        </div>
    `;
}

function startMemoryGame() {
    document.getElementById('back-to-mindzone').addEventListener('click', renderMindZoneMenu);

    const grid = document.getElementById('memory-grid');
    const movesEl = document.getElementById('memory-moves');
    const icons = ['dog', 'cat', 'hippo', 'horse', 'frog', 'fish', 'dove', 'crow'];
    const cardIcons = [...icons, ...icons];
    let moves = 0;
    let hasFlippedCard = false;
    let lockBoard = false;
    let firstCard, secondCard;

    cardIcons.sort(() => 0.5 - Math.random());

    cardIcons.forEach(icon => {
        const cardContainer = document.createElement('div');
        cardContainer.classList.add('memory-card-container');
        cardContainer.innerHTML = `
            <div class="memory-card" data-icon="${icon}">
                <div class="back-face bg-primary"></div>
                <div class="front-face bg-white text-dark-text text-3xl"><i class="fas fa-${icon}"></i></div>
            </div>
        `;
        grid.appendChild(cardContainer);
    });

    const cards = document.querySelectorAll('.memory-card');

    function flipCard() {
        if (lockBoard || this === firstCard) return;
        this.classList.add('flip');

        if (!hasFlippedCard) {
            hasFlippedCard = true;
            firstCard = this;
            return;
        }
        secondCard = this;
        moves++;
        movesEl.textContent = moves;
        checkForMatch();
    }

    function checkForMatch() {
        const isMatch = firstCard.dataset.icon === secondCard.dataset.icon;
        isMatch ? disableCards() : unflipCards();
    }

    function disableCards() {
        firstCard.removeEventListener('click', flipCard);
        secondCard.removeEventListener('click', flipCard);
        resetBoard();
    }

    function unflipCards() {
        lockBoard = true;
        setTimeout(() => {
            firstCard.classList.remove('flip');
            secondCard.classList.remove('flip');
            resetBoard();
        }, 1200);
    }

    function resetBoard() {
        [hasFlippedCard, lockBoard] = [false, false];
        [firstCard, secondCard] = [null, null];
    }
    
    cards.forEach(card => card.addEventListener('click', flipCard));
}


function attachLibraryListeners() {
    document.querySelectorAll('.article-card').forEach(card => {
        card.addEventListener('click', (e) => {
            const articleId = parseInt(e.currentTarget.dataset.articleId, 10);
            selectedArticle = CONTENT[currentLanguage].ARTICLES.find(a => a.id === articleId);
            render();
        });
    });
}

function attachCommunityListeners() {
    document.getElementById('publish-post-btn').addEventListener('click', () => {
        const input = document.getElementById('new-post-input');
        if(input.value.trim()){
            COMMUNITY_POSTS.unshift({ id: Date.now(), author: userData.name, content: input.value, likes: 0, comments: [] });
            saveCommunityPosts();
            input.value = '';
            showToast(t('postShared'));
            document.getElementById('view-content').innerHTML = getCommunityViewHTML();
            attachCommunityListeners();
        }
    });

    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const postId = parseInt(e.currentTarget.dataset.postId, 10);
            const post = COMMUNITY_POSTS.find(p => p.id === postId);
            if(post) {
                const likedIndex = userData.likedPosts.indexOf(postId);
                if (likedIndex > -1) {
                    userData.likedPosts.splice(likedIndex, 1);
                    post.likes--;
                } else {
                    userData.likedPosts.push(postId);
                    post.likes++;
                }
                saveUserData();
                saveCommunityPosts();
                document.getElementById('view-content').innerHTML = getCommunityViewHTML();
                attachCommunityListeners();
            }
        });
    });

    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const postId = parseInt(e.currentTarget.dataset.postId, 10);
            showCommentsModal(postId);
        });
    });

    document.getElementById('community-profile-btn')?.addEventListener('click', showMyWallModal);
    document.getElementById('community-friends-btn')?.addEventListener('click', showFriendsModal);
    document.getElementById('community-search-btn')?.addEventListener('click', () => {
        showFriendsModal();
        setTimeout(() => document.getElementById('friend-search-input')?.focus(), 100);
    });
    document.getElementById('community-messages-btn')?.addEventListener('click', showMessagesModal);
}

function calculateMentalHealthRisk() {
    const recentHistory = userData.emotionHistory.slice(-14);
    if (recentHistory.length < 3) {
        return { level: t('riskLevels.low'), emoji: 'üòä', bgColor: 'bg-green-500', textColor: 'text-white' };
    }

    const scoreMap = { "HORRIBLE": 1, "MAL": 2, "OKAY": 3, "BIEN": 4, "GENIAL": 5 };
    const totalScore = recentHistory.reduce((sum, entry) => sum + (scoreMap[entry.emotion] || 3), 0);
    const averageScore = totalScore / recentHistory.length;

    if (averageScore >= 3.75) {
        return { level: t('riskLevels.low'), emoji: 'üòä', bgColor: 'bg-green-500', textColor: 'text-white' };
    } else if (averageScore >= 2.5) {
        return { level: t('riskLevels.medium'), emoji: 'üòê', bgColor: 'bg-yellow-500', textColor: 'text-white' };
    } else {
        return { level: t('riskLevels.high'), emoji: 'üòü', bgColor: 'bg-red-500', textColor: 'text-white' };
    }
}

function calculateProfileStats() {
    const stats = {
        streak: userData.streak,
        totalEntries: userData.emotionHistory.length,
        mostFrequentEmotion: "N/A",
        emotionCounts: {}
    };

    if (stats.totalEntries === 0) return stats;

    const emotionCounts = userData.emotionHistory.reduce((acc, record) => {
        acc[record.emotion] = (acc[record.emotion] || 0) + 1;
        return acc;
    }, {});

    stats.emotionCounts = emotionCounts;

    let maxCount = 0;
    for (const emotion in emotionCounts) {
        if (emotionCounts[emotion] > maxCount) {
            maxCount = emotionCounts[emotion];
            stats.mostFrequentEmotion = emotion;
        }
    }
    return stats;
}


// ===================================================================================
// V. ONBOARDING
// ===================================================================================

function renderOnboarding() {
    let content = '';
    switch (onboardingStep) {
        case 0: content = getOnboardingWelcomeHTML(); break;
        case 1: content = getOnboardingNameHTML(); break;
        case 2: content = getOnboardingGoalsHTML(); break;
        case 3: content = getOnboardingConditionHTML(); break;
        case 4: content = `<div class="text-center p-6 h-full flex flex-col justify-center items-center"><i class="fas fa-cog fa-spin text-6xl text-primary mb-6"></i><h2 class="text-2xl font-bold">${t('settingUp')}</h2></div>`; break;
    }
    appContainer.innerHTML = `<main class="h-screen bg-light-bg">${content}</main>`;
    attachOnboardingListeners();
}

function getOnboardingWelcomeHTML() {
    return `
        <div class="text-center flex flex-col justify-center items-center h-full p-6">
            <img src="./imagenes/totuss.png" alt="Totus Logo" class="w-80 h-80 mb-6" />
            <h1 class="text-3xl font-bold text-primary mb-2">${t('welcomeTitle')}</h1>
            <p class="text-gray-600 max-w-xs mb-8">${t('welcomeSubtitle')}</p>
            <button id="start-onboarding-btn" class="bg-primary text-white font-bold py-3 px-8 rounded-lg text-lg">${t('getStarted')}</button>
        </div>`;
}

function getOnboardingNameHTML() {
    return `
        <div class="p-6 h-full flex flex-col justify-center">
            <div>
                <h2 class="text-2xl font-bold text-primary mb-4">${t('whatIsYourName')}</h2>
                <input id="name-input" type="text" placeholder="${t('namePlaceholder')}" class="w-full p-3 border border-gray-300 rounded-lg text-lg mb-8" />
            </div>
            <div class="pb-4">
                <div class="flex space-x-4">
                    <button id="back-btn" class="w-1/3 bg-gray-200 text-dark-text font-bold py-3 rounded-lg">${t('back')}</button>
                    <button id="next-btn-name" class="w-2/3 bg-primary text-white font-bold py-3 rounded-lg opacity-50" disabled>${t('next')}</button>
                </div>
            </div>
        </div>`;
}

function getOnboardingGoalsHTML() {
    const allGoals = t('goals');
    return `
        <div class="p-6 h-full flex flex-col justify-center">
             <div>
                <h2 class="text-2xl font-bold text-primary mb-2">${t('whatAreYourGoals')}</h2>
                <p class="text-gray-500 mb-4">${t('goalsSubtitle')}</p>
                <div class="space-y-3 mb-8">
                    ${allGoals.map(goal => `<button data-goal="${goal}" class="goal-btn w-full p-4 border-2 rounded-lg text-left font-semibold bg-white border-gray-300 text-dark-text">${goal}</button>`).join('')}
                </div>
            </div>
            <div class="pb-4">
                <div class="flex space-x-4">
                     <button id="back-btn" class="w-1/3 bg-gray-200 text-dark-text font-bold py-3 rounded-lg">${t('back')}</button>
                     <button id="next-btn-goals" class="w-2/3 bg-primary text-white font-bold py-3 rounded-lg opacity-50" disabled>${t('next')}</button>
                </div>
            </div>
        </div>`;
}

function getOnboardingConditionHTML() {
    return `
        <div class="p-6 h-full flex flex-col justify-center">
             <div>
                <h2 class="text-2xl font-bold text-primary mb-4">${t('conditionQuestion')}</h2>
                <p class="text-gray-600 mb-6">${t('conditionSubtitle')}</p>
                <input type="text" id="condition-input" class="w-full p-3 border border-gray-300 rounded-lg mb-8" placeholder="${t('conditionPlaceholder')}" />
            </div>
            <div class="pb-4">
                <div class="flex space-x-4">
                     <button id="back-btn" class="w-1/3 bg-gray-200 text-dark-text font-bold py-3 rounded-lg">${t('back')}</button>
                     <button id="finish-onboarding-btn" class="w-2/3 bg-primary text-white font-bold py-3 rounded-lg">${t('finish')}</button>
                </div>
            </div>
        </div>`;
}


function attachOnboardingListeners() {
    const backBtn = document.getElementById('back-btn');
    if (backBtn) backBtn.addEventListener('click', () => { if(onboardingStep > 0) { onboardingStep--; render(); } });

    if (onboardingStep === 0) {
        document.getElementById('start-onboarding-btn').addEventListener('click', () => { onboardingStep = 1; render(); });
    } else if (onboardingStep === 1) {
        const nameInput = document.getElementById('name-input');
        const nextBtn = document.getElementById('next-btn-name');
        nameInput.addEventListener('input', () => {
            const enabled = nameInput.value.trim().length > 0;
            nextBtn.disabled = !enabled;
            nextBtn.classList.toggle('opacity-50', !enabled);
        });
        nextBtn.addEventListener('click', () => {
            if (!nextBtn.disabled) { onboardingData.name = nameInput.value.trim(); onboardingStep = 2; render(); }
        });
    } else if (onboardingStep === 2) {
        const nextBtn = document.getElementById('next-btn-goals');
        document.querySelectorAll('.goal-btn').forEach(btn => {
            // Pre-select if already in data
            if (onboardingData.goals.includes(btn.dataset.goal)) {
                 btn.classList.add('bg-primary', 'text-white');
                 btn.classList.remove('bg-white', 'text-dark-text');
            }
            btn.addEventListener('click', e => {
                const goal = e.currentTarget.dataset.goal;
                const isSelected = e.currentTarget.classList.contains('bg-primary');
                if (isSelected) {
                    e.currentTarget.classList.remove('bg-primary', 'text-white');
                    e.currentTarget.classList.add('bg-white', 'text-dark-text');
                    onboardingData.goals = onboardingData.goals.filter(g => g !== goal);
                } else {
                    e.currentTarget.classList.add('bg-primary', 'text-white');
                    e.currentTarget.classList.remove('bg-white', 'text-dark-text');
                    onboardingData.goals.push(goal);
                }
                const enabled = onboardingData.goals.length > 0;
                nextBtn.disabled = !enabled;
                nextBtn.classList.toggle('opacity-50', !enabled);
            });
        });
        // Check initial state for the button
        const enabled = onboardingData.goals.length > 0;
        nextBtn.disabled = !enabled;
        nextBtn.classList.toggle('opacity-50', !enabled);
        
        nextBtn.addEventListener('click', () => { if (!nextBtn.disabled) { onboardingStep = 3; render(); }});
    } else if (onboardingStep === 3) {
        document.getElementById('finish-onboarding-btn').addEventListener('click', () => {
            onboardingData.condition = document.getElementById('condition-input').value;
            onboardingStep = 4;
            render();
            setTimeout(() => {
                userData = createNewUser(onboardingData);
                saveUserData();
                onboardingStep = 99;
                currentView = 'home';
                init();
            }, 2000);
        });
    }
}

// ===================================================================================
// V. MODALS & TOASTS
// ===================================================================================

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-dark-text text-white font-semibold py-2 px-5 rounded-full shadow-lg fade-in z-50';
    toast.textContent = message;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showModal(contentHTML, options = {}) {
    const { isLarge = false, isFullScreen = false } = options;
    const modalContainer = document.getElementById('modal-container');
    
    let sizeClasses = 'max-w-md';
    if (isLarge) sizeClasses = 'max-w-3xl';
    if (isFullScreen) sizeClasses = 'w-full h-full max-w-none max-h-none rounded-none';

    modalContainer.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
            <div id="modal-content" class="bg-[var(--theme-card-bg)] rounded-2xl w-full ${sizeClasses} shadow-xl transition-all duration-300">
                ${contentHTML}
            </div>
        </div>`;

    const closeModal = () => modalContainer.innerHTML = '';
    
    const closeBtn = modalContainer.querySelector('.close-modal-btn');
    if (closeBtn) closeBtn.addEventListener('click', closeModal);

    return { modalContainer, closeModal };
}

function showSettingsModal() {
    const themeOptions = [
        { id: 'totus', name: t('themes.totus'), colors: ['bg-primary', 'bg-secondary'] },
        { id: 'cerezo', name: t('themes.cerezo'), colors: ['bg-[#d63384]', 'bg-[#f8b4d9]'] },
        { id: 'serenidad', name: t('themes.serenidad'), colors: ['bg-[#064e3b]', 'bg-[#a7f3d0]'] }
    ];
    
    const themeButtonsHTML = themeOptions.map(theme => `
        <button data-theme="${theme.id}" class="theme-option-btn w-full text-left p-3 rounded-lg flex items-center justify-between hover:bg-gray-100/50 ${userData.appTheme === theme.id ? 'bg-gray-500/20' : ''}">
            <span class="font-semibold text-[var(--theme-dark-text)]">${theme.name}</span>
            <div class="flex items-center space-x-1">
                <span class="w-5 h-5 rounded-full ${theme.colors[0]}"></span>
                <span class="w-5 h-5 rounded-full ${theme.colors[1]}"></span>
            </div>
        </button>
    `).join('');

    const content = `
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-[var(--theme-primary)]">${t('settings')}</h3>
            <button class="close-modal-btn text-2xl" style="color: var(--theme-text-secondary);">&times;</button>
        </div>
        
        <div class="mb-6">
            <label for="new-name-input" class="font-semibold text-[var(--theme-dark-text)] text-sm">${t('changeName')}</label>
            <div class="mt-2 space-y-3">
                <input id="new-name-input" type="text" class="w-full p-2 border border-[var(--theme-input-border)] rounded-lg bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" value="${userData.name}">
                <button id="save-name-btn" class="w-full bg-[var(--theme-primary)] text-white py-2 px-4 rounded-lg">${t('save')}</button>
            </div>
        </div>
        
        <div class="mb-6">
            <h4 class="font-semibold text-[var(--theme-dark-text)] text-sm mb-2">${t('customizeAppearance')}</h4>
            <div class="space-y-2">${themeButtonsHTML}</div>
        </div>

        <div>
             <h4 class="font-semibold text-[var(--theme-dark-text)] text-sm mb-2">${t('language')}</h4>
             <div class="flex space-x-2">
                <button data-lang="es" class="lang-btn flex-1 py-2 rounded-lg text-sm font-semibold ${currentLanguage === 'es' ? 'bg-[var(--theme-primary)] text-white' : 'bg-gray-200 text-dark-text'}">Espa√±ol</button>
                <button data-lang="en" class="lang-btn flex-1 py-2 rounded-lg text-sm font-semibold ${currentLanguage === 'en' ? 'bg-[var(--theme-primary)] text-white' : 'bg-gray-200 text-dark-text'}">English</button>
             </div>
        </div>
      </div>
    `;
    const { closeModal } = showModal(content);
    
    document.getElementById('save-name-btn').addEventListener('click', () => {
        const newName = document.getElementById('new-name-input').value.trim();
        if (newName) {
            userData.name = newName;
            saveUserData();
            showToast(t('nameUpdated'));
            closeModal();
            renderProfilePage();
        } else {
            showToast(t('nameNotEmpty'));
        }
    });

    document.querySelectorAll('.theme-option-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const theme = e.currentTarget.dataset.theme;
            userData.appTheme = theme;
            document.body.dataset.theme = theme;
            saveUserData();
            closeModal();
            init();
        });
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const lang = e.currentTarget.dataset.lang;
            if (lang !== currentLanguage) {
                currentLanguage = lang;
                userData.language = lang;
                saveUserData();
                closeModal();
                init();
            }
        });
    });
}


function showEditBioModal() {
    const content = `
      <div class="p-6">
        <h3 class="text-xl font-bold text-[var(--theme-primary)] mb-4">${t('editMotto')}</h3>
        <textarea id="new-bio-input" class="w-full p-2 border border-[var(--theme-input-border)] rounded-lg mt-2 mb-4 bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" rows="3">${userData.bio}</textarea>
        <div class="flex space-x-2">
            <button class="close-modal-btn flex-1 bg-gray-200 text-dark-text font-bold py-2 rounded-lg">${t('cancel')}</button>
            <button id="save-bio-btn" class="flex-1 bg-primary text-white py-2 rounded-lg">${t('save')}</button>
        </div>
      </div>
    `;
    const { closeModal } = showModal(content);
    
    document.getElementById('save-bio-btn').addEventListener('click', () => {
        const newBio = document.getElementById('new-bio-input').value.trim();
        if (newBio) {
            userData.bio = newBio;
            saveUserData();
            showToast(t('mottoUpdated'));
            closeModal();
            renderProfilePage();
        } else {
            showToast(t('mottoNotEmpty'));
        }
    });
}

// ----- DIARY -----
function showDiaryModal() {
    diaryState = { 
        view: 'notebook', 
        currentPageIndex: userData.diaryEntries.length > 0 ? userData.diaryEntries.length - 1 : 0, 
        isDrawing: false, 
        tempEntryData: null 
    };
    const modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-0 sm:p-4">
            <div id="diary-notebook-container" class="w-full h-full">
                <!-- Diary content rendered by renderDiaryView -->
            </div>
        </div>
    `;
    document.getElementById('modal-container').innerHTML = modalContent;
    renderDiaryView();
}

function renderDiaryView() {
    const container = document.getElementById('diary-notebook-container');
    if (!container) return;
    
    const sortedEntries = [...userData.diaryEntries].sort((a,b) => new Date(a.date) - new Date(b.date));
    let currentEntry = sortedEntries[diaryState.currentPageIndex];
    if (diaryState.currentPageIndex >= sortedEntries.length) { // New entry case
        currentEntry = null;
    }
    
    container.innerHTML = `
        <div class="diary-container diary-theme-${userData.appTheme || 'totus'} w-full h-full rounded-none sm:rounded-2xl shadow-2xl p-4 sm:p-6 flex flex-col relative overflow-hidden">
            ${getDiaryPageHTML(currentEntry)}
        </div>
    `;
    attachDiaryListeners(sortedEntries, currentEntry);
}

function getDiaryPageHTML(entry) {
    const isNewEntry = !entry;
    const entryData = diaryState.tempEntryData || entry || { emotion: null, title: '', content: '', image: null, audio: null, drawing: null, date: new Date().toISOString() };
    const pageDate = new Date(entryData.date).toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

    let mainContent;
    if (diaryState.isDrawing) {
        mainContent = `
            <div class="flex-1 relative border-2 border-dashed border-[var(--diary-border)] rounded-lg bg-[var(--diary-canvas-bg)]">
                <canvas id="drawing-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>
        `;
    } else {
        mainContent = `
            <input id="diary-title-input" type="text" class="w-full text-2xl font-bold bg-transparent border-b-2 py-2 mb-3 focus:outline-none focus:border-[var(--diary-accent)]" placeholder="${t('diary.entryTitlePlaceholder')}" value="${entryData.title || ''}">
            <div class="flex-1 relative">
                <textarea id="diary-content-input" class="w-full h-full absolute top-0 left-0 bg-transparent text-base resize-none focus:outline-none" placeholder="${t('diary.entryContentPlaceholder')}">${entryData.content || ''}</textarea>
            </div>
            <div id="media-preview" class="space-y-2 mt-4 max-h-40 overflow-y-auto no-scrollbar">
                ${entryData.image ? `<div class="relative w-1/2"><img src="${entryData.image}" class="rounded-lg"/><button data-media="image" class="remove-media-btn absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6">&times;</button></div>` : ''}
                ${entryData.audio ? `<div class="relative flex items-center space-x-2 p-2 bg-black/10 rounded-lg w-1/2"><i class="fas fa-play-circle text-xl"></i><div class="w-full h-1 bg-black/30 rounded-full"></div><button data-media="audio" class="remove-media-btn bg-black/50 text-white rounded-full w-6 h-6">&times;</button></div>` : ''}
                ${entryData.drawing ? `<div class="relative w-1/2"><img src="${entryData.drawing}" class="rounded-lg border-2 border-black/20 bg-white"/><button data-media="drawing" class="remove-media-btn absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6">&times;</button></div>` : ''}
            </div>
        `;
    }
    
    const drawingToolbar = `
        <div id="drawing-toolbar" class="flex flex-wrap items-center gap-2">
            <div id="color-palette" class="flex space-x-1">
                <button class="color-swatch w-6 h-6 rounded-full border-2 border-[var(--diary-accent)]" style="background-color: var(--diary-text);"></button>
                <button class="color-swatch w-6 h-6 rounded-full" style="background-color: #ef4444;"></button>
                <button class="color-swatch w-6 h-6 rounded-full" style="background-color: #3b82f6;"></button>
                <button class="color-swatch w-6 h-6 rounded-full" style="background-color: #22c55e;"></button>
            </div>
            <input type="range" id="brush-size" min="1" max="20" value="5" class="w-20" title="${t('diary.drawingTools.brushSize')}">
            <button id="eraser-btn" class="toolbar-btn text-lg" title="${t('diary.drawingTools.eraser')}"><i class="fas fa-eraser"></i></button>
            <button id="finish-drawing-btn" class="ml-auto bg-[var(--diary-accent)] text-[var(--diary-bg)] text-sm font-bold py-1 px-3 rounded-lg">${t('diary.drawingTools.done')}</button>
        </div>
    `;

    const writingToolbar = `
        <div id="writing-toolbar" class="flex items-center space-x-2">
            <div class="flex space-x-1">${EMOTIONS.map(e => `
                <button data-emotion="${e.name}" class="emotion-select-btn p-1 rounded-full transform hover:scale-110 transition-transform ${entryData.emotion === e.name ? 'bg-black/20' : ''}">
                    <img src="${e.image}" alt="${e.name}" class="w-7 h-7"/>
                </button>
            `).join('')}</div>
            <div class="border-l border-[var(--diary-border)] h-6 mx-2"></div>
            <button id="add-photo-btn" class="toolbar-btn text-lg"><i class="fas fa-image"></i></button>
            <button id="add-audio-btn" class="toolbar-btn text-lg"><i class="fas fa-microphone"></i></button>
            <button id="add-drawing-btn" class="toolbar-btn text-lg"><i class="fas fa-paint-brush"></i></button>
        </div>
    `;

    return `
        <div class="flex justify-between items-center mb-4 shrink-0">
            <p class="font-semibold text-sm sm:text-base">${pageDate}</p>
            <button id="close-diary-btn" class="text-2xl hover:bg-black/10 rounded-full w-8 h-8">&times;</button>
        </div>
        
        <div class="flex justify-between items-center mb-4 shrink-0 pb-2 border-b border-[var(--diary-border)]">
             ${diaryState.isDrawing ? drawingToolbar : writingToolbar}
             ${!isNewEntry ? `<button id="delete-entry-btn" class="toolbar-btn text-red-500 text-lg"><i class="fas fa-trash"></i></button>`: ''}
        </div>
        
        <div class="flex-1 flex flex-col overflow-y-auto no-scrollbar pr-2 min-h-[200px]">${mainContent}</div>
        
        <div class="shrink-0 pt-4 mt-auto">
            <div class="flex flex-wrap items-center justify-center sm:justify-between gap-2 border-t border-[var(--diary-border)] pt-4">
                <button id="prev-page-btn" class="font-semibold p-2 rounded-lg hover:bg-black/10"><i class="fas fa-chevron-left mr-2"></i> ${t('diary.previous')}</button>
                <div class="flex items-center gap-2 order-first sm:order-none w-full sm:w-auto">
                    <button id="save-entry-btn" class="flex-1 bg-[var(--diary-accent)] text-[var(--diary-bg)] font-bold py-2 px-4 rounded-lg">${isNewEntry ? t('diary.saveEntry') : t('diary.updateEntry')}</button>
                    <button id="new-entry-btn" class="flex-1 bg-transparent border-2 border-[var(--diary-accent)] font-bold py-2 px-4 rounded-lg">${t('diary.newEntry')}</button>
                </div>
                <button id="next-page-btn" class="font-semibold p-2 rounded-lg hover:bg-black/10">${t('diary.nextPage')} <i class="fas fa-chevron-right ml-2"></i></button>
            </div>
        </div>
        <style>.toolbar-btn { padding: 8px; border-radius: 9999px; } .toolbar-btn:hover { background-color: rgba(0,0,0,0.1); }</style>
    `;
}

function attachDiaryListeners(sortedEntries, currentEntry) {
    const isNewEntry = !currentEntry;
    
    document.getElementById('close-diary-btn').addEventListener('click', () => { document.getElementById('modal-container').innerHTML = ''; });

    document.getElementById('prev-page-btn').disabled = diaryState.currentPageIndex <= 0;
    document.getElementById('next-page-btn').disabled = diaryState.currentPageIndex >= sortedEntries.length - 1 && sortedEntries.length > 0;

    document.getElementById('prev-page-btn').addEventListener('click', () => {
        if (diaryState.currentPageIndex > 0) {
            diaryState.currentPageIndex--;
            diaryState.tempEntryData = null;
            renderDiaryView();
        }
    });

    document.getElementById('next-page-btn').addEventListener('click', () => {
        if (diaryState.currentPageIndex < sortedEntries.length - 1) {
            diaryState.currentPageIndex++;
            diaryState.tempEntryData = null;
            renderDiaryView();
        }
    });
    
    document.getElementById('new-entry-btn').addEventListener('click', () => {
        diaryState.currentPageIndex = sortedEntries.length;
        diaryState.tempEntryData = null;
        renderDiaryView();
    });

    const saveCurrentEntry = () => {
        const title = document.getElementById('diary-title-input')?.value.trim() || diaryState.tempEntryData?.title || '';
        const content = document.getElementById('diary-content-input')?.value.trim() || diaryState.tempEntryData?.content || '';
        const emotion = document.querySelector('.emotion-select-btn.bg-black\\/20')?.dataset.emotion || diaryState.tempEntryData?.emotion || null;
        
        const tempMedia = diaryState.tempEntryData || {};
        const image = document.querySelector('#media-preview img[src^="https://"]')?.src || tempMedia.image || null;
        const audio = !!document.querySelector('#media-preview button[data-media="audio"]') || tempMedia.audio || null;
        const drawing = document.querySelector('#media-preview img[src^="data:image"]')?.src || tempMedia.drawing || null;
        
        if (!content && !title && !image && !audio && !drawing) {
            showToast(t('entryCannotBeEmpty'));
            return;
        }

        const newEntryData = { title, content, emotion, image, audio, drawing };

        if (isNewEntry || diaryState.currentPageIndex >= sortedEntries.length) {
            userData.diaryEntries.push({ id: Date.now(), date: new Date().toISOString(), ...newEntryData });
            showToast(t('entrySaved'));
            diaryState.currentPageIndex = userData.diaryEntries.length - 1;
        } else {
            const entryIndex = userData.diaryEntries.findIndex(e => e.id === currentEntry.id);
            if (entryIndex > -1) {
                userData.diaryEntries[entryIndex] = { ...currentEntry, ...newEntryData };
                showToast(t('entryUpdated'));
            }
        }
        diaryState.tempEntryData = null;
        saveUserData();
        renderDiaryView();
    };
    
    document.getElementById('save-entry-btn').addEventListener('click', saveCurrentEntry);
    
    const storeTempState = () => {
        const entryData = diaryState.tempEntryData || currentEntry || {};
        const title = document.getElementById('diary-title-input')?.value;
        const content = document.getElementById('diary-content-input')?.value;
        const emotion = document.querySelector('.emotion-select-btn.bg-black\\/20')?.dataset.emotion;
        
        diaryState.tempEntryData = { ...entryData };
        if (title !== undefined) diaryState.tempEntryData.title = title;
        if (content !== undefined) diaryState.tempEntryData.content = content;
        if (emotion !== undefined) diaryState.tempEntryData.emotion = emotion;
    };

    if (diaryState.isDrawing) {
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        let drawing = false;
        let brushColor = getComputedStyle(canvas.closest('.diary-container')).getPropertyValue('--diary-text').trim();
        let brushSize = 5;

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        function startPosition(e) { e.preventDefault(); drawing = true; draw(e); }
        function finishedPosition() { drawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            let pos = getPos(e);
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.strokeStyle = brushColor;
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startPosition);
        canvas.addEventListener('touchend', finishedPosition);
        canvas.addEventListener('touchmove', draw);

        document.querySelectorAll('#color-palette .color-swatch').forEach(swatch => {
            swatch.addEventListener('click', e => {
                brushColor = e.target.style.backgroundColor;
                document.querySelectorAll('#color-palette .color-swatch').forEach(s => s.classList.remove('border-2', 'border-[var(--diary-accent)]'));
                e.target.classList.add('border-2', 'border-[var(--diary-accent)]');
            });
        });
        document.getElementById('brush-size').addEventListener('input', e => { brushSize = e.target.value; });
        document.getElementById('eraser-btn').addEventListener('click', () => { 
            brushColor = getComputedStyle(canvas.closest('.diary-container')).getPropertyValue('--diary-canvas-bg').trim();
            document.querySelectorAll('#color-palette .color-swatch').forEach(s => s.classList.remove('border-2', 'border-[var(--diary-accent)]'));
        });
        document.getElementById('finish-drawing-btn').addEventListener('click', () => {
            storeTempState();
            diaryState.tempEntryData.drawing = canvas.toDataURL('image/png');
            diaryState.isDrawing = false;
            renderDiaryView();
        });

    } else { // Writing mode listeners
        document.querySelectorAll('.emotion-select-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const isSelected = e.currentTarget.classList.contains('bg-black/20');
                document.querySelectorAll('.emotion-select-btn').forEach(b => b.classList.remove('bg-black/20'));
                if (!isSelected) {
                    e.currentTarget.classList.add('bg-black/20');
                }
            });
        });
        document.getElementById('add-photo-btn').addEventListener('click', () => {
            storeTempState();
            diaryState.tempEntryData.image = `https://picsum.photos/seed/diary${Date.now()}/400/200`;
            renderDiaryView();
        });
        document.getElementById('add-audio-btn').addEventListener('click', () => {
            storeTempState();
            diaryState.tempEntryData.audio = true;
            renderDiaryView();
        });
        document.getElementById('add-drawing-btn').addEventListener('click', () => {
            storeTempState();
            diaryState.isDrawing = true;
            renderDiaryView();
        });
        document.querySelectorAll('.remove-media-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const mediaType = e.currentTarget.dataset.media;
                storeTempState();
                if(diaryState.tempEntryData) diaryState.tempEntryData[mediaType] = null;
                renderDiaryView();
            });
        });
        const deleteBtn = document.getElementById('delete-entry-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                showModal(`
                <div class="p-6 text-center bg-[var(--theme-card-bg)] rounded-2xl">
                    <h3 class="text-xl font-bold text-[var(--theme-primary)] mb-4">${t('diary.deleteEntryTitle')}</h3>
                    <p style="color: var(--theme-text-secondary);" class="mb-6">${t('diary.deleteEntrySubtitle')}</p>
                    <div class="flex space-x-2">
                        <button class="close-modal-btn flex-1 bg-gray-200 py-2 rounded-lg text-dark-text">${t('cancel')}</button>
                        <button id="confirm-delete-btn" class="flex-1 bg-red-500 text-white py-2 rounded-lg">${t('delete')}</button>
                    </div>
                </div>`).modalContainer.querySelector('#confirm-delete-btn').addEventListener('click', () => {
                    userData.diaryEntries = userData.diaryEntries.filter(e => e.id !== currentEntry.id);
                    saveUserData();
                    showToast(t('entryDeleted'));
                    document.getElementById('modal-container').innerHTML = ''; // Close all modals
                    showDiaryModal(); // Re-open diary
                });
            });
        }
    }
}


function showDonateModal() {
     const content = `
       <div class="p-6">
        <h3 class="text-xl font-bold text-[var(--theme-primary)] mb-4">${t('supportTotus')}</h3>
        <p style="color: var(--theme-text-secondary);" class="mb-6">${t('donateMessage')}</p>
        <div class="grid grid-cols-3 gap-4 mb-6">
             <button class="donate-amount-btn border-2 border-[var(--theme-primary)] text-[var(--theme-primary)] font-bold py-3 rounded-lg hover:bg-[var(--theme-primary)] hover:text-white">$5</button>
             <button class="donate-amount-btn border-2 border-[var(--theme-primary)] text-[var(--theme-primary)] font-bold py-3 rounded-lg hover:bg-[var(--theme-primary)] hover:text-white">$10</button>
             <button class="donate-amount-btn border-2 border-[var(--theme-primary)] text-[var(--theme-primary)] font-bold py-3 rounded-lg hover:bg-[var(--theme-primary)] hover:text-white">$25</button>
        </div>
        <button class="close-modal-btn w-full bg-gray-200 py-2 rounded-lg text-dark-text">${t('close')}</button>
       </div>
       `;
    const { closeModal } = showModal(content);
    document.querySelectorAll('.donate-amount-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            showToast(t('thankYouGenerosity'));
            closeModal();
        });
    });
}

function showVolunteerModal() {
    const content = `
      <div class="p-6">
        <h3 class="text-xl font-bold text-[var(--theme-primary)] mb-4">${t('joinTeam')}</h3>
        <p style="color: var(--theme-text-secondary);" class="mb-6">${t('volunteerMessage')}</p>
        <button id="apply-volunteer-btn" class="w-full bg-[var(--theme-primary)] text-white font-bold py-3 rounded-lg mb-4">${t('applyNow')}</button>
        <button class="close-modal-btn w-full bg-gray-200 py-2 rounded-lg text-dark-text">${t('close')}</button>
      </div>
      `;
    const { closeModal } = showModal(content);
    
    document.getElementById('apply-volunteer-btn').addEventListener('click', () => {
        closeModal();
        showToast(t('thankYouJoining'));
    });
}

function showCommentsModal(postId) {
    const post = COMMUNITY_POSTS.find(p => p.id === postId);
    if (!post) return;

    const commentsHTML = post.comments.map(comment => `
        <div class="p-2 border-b border-[var(--theme-input-border)] last:border-b-0">
            <p class="font-bold text-sm text-[var(--theme-primary)]">${comment.author}</p>
            <p class="text-sm text-[var(--theme-dark-text)]">${comment.text}</p>
        </div>
    `).join('') || `<p class="text-center text-sm" style="color: var(--theme-text-secondary);">${t('noCommentsYet')}</p>`;

    const content = `
      <div class="p-6">
        <h3 class="text-xl font-bold text-[var(--theme-primary)] mb-4">${t('comments')}</h3>
        <div class="max-h-48 overflow-y-auto no-scrollbar bg-[var(--theme-light-bg)] rounded-lg p-2 mb-4">${commentsHTML}</div>
        <textarea id="new-comment-input" placeholder="${t('addComment')}" class="w-full p-2 border border-[var(--theme-input-border)] rounded-lg bg-[var(--theme-card-bg)] text-[var(--theme-dark-text)]" rows="2"></textarea>
        <div class="flex space-x-2 mt-4">
            <button class="close-modal-btn flex-1 bg-gray-200 text-dark-text font-bold py-2 rounded-lg">${t('close')}</button>
            <button id="publish-comment-btn" class="flex-1 bg-[var(--theme-primary)] text-white py-2 rounded-lg">${t('publish')}</button>
        </div>
      </div>
      `;
    const { closeModal } = showModal(content);
    
    document.getElementById('publish-comment-btn').addEventListener('click', () => {
        const input = document.getElementById('new-comment-input');
        const newCommentText = input.value.trim();
        if (newCommentText) {
            post.comments.push({ author: userData.name, text: newCommentText });
            saveCommunityPosts();
            closeModal();
            showToast(t('commentPublished'));
            currentView = 'community';
            render();
        }
    });
}

function showMyWallModal() {
    const myPosts = COMMUNITY_POSTS.filter(p => p.author === userData.name);
    const myPostsHTML = myPosts.length > 0 ? myPosts.map(post => `
        <div class="bg-[var(--theme-light-bg)] rounded-lg p-3 mb-3">
            <p class="text-sm text-[var(--theme-dark-text)]">${post.content}</p>
            <div class="text-xs mt-2 flex items-center space-x-3" style="color: var(--theme-text-secondary);">
                <span><i class="fas fa-heart"></i> ${post.likes}</span>
                <span><i class="fas fa-comment"></i> ${post.comments.length}</span>
            </div>
        </div>
    `).join('') : `<p class="text-center text-sm py-4" style="color: var(--theme-text-secondary);">${t('noPostsYet')}</p>`;

    const content = `
        <div class="relative">
             <button class="close-modal-btn absolute top-2 right-2 text-2xl text-black bg-white/70 rounded-full w-8 h-8 flex items-center justify-center hover:bg-white/90 z-20">&times;</button>
             <div class="h-24 bg-gradient-to-r from-primary to-primary-light rounded-t-2xl relative">
                <img src="https://picsum.photos/seed/abstract-banner-user/800/300" class="w-full h-full object-cover rounded-t-2xl" />
             </div>
             <div class="absolute -bottom-10 left-4 z-10">
                <img src="${userData.avatarImage}" alt="${userData.name}" class="w-20 h-20 rounded-full object-cover border-4 border-[var(--theme-card-bg)] shadow-md"/>
             </div>
        </div>
        <div class="pt-12 px-4 pb-4">
            <h3 class="text-xl font-bold text-[var(--theme-dark-text)]">${userData.name}</h3>
            
            <div class="flex space-x-2 my-4">
                <button id="change-avatar-btn" class="flex-1 bg-gray-200 text-dark-text text-sm font-semibold py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-camera mr-1"></i> ${t('changePhoto')}</button>
                <button id="edit-profile-btn" class="flex-1 bg-gray-200 text-dark-text text-sm font-semibold py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-edit mr-1"></i> ${t('editMotto')}</button>
            </div>

            <h4 class="font-bold text-[var(--theme-dark-text)] border-b pb-2 mb-2">${t('myPosts')}</h4>
            <div class="max-h-60 overflow-y-auto no-scrollbar pr-2">
                ${myPostsHTML}
            </div>
        </div>`;
        
    const { modalContainer, closeModal } = showModal(content);
    
    modalContainer.querySelector('.close-modal-btn').addEventListener('click', closeModal);
    modalContainer.querySelector('#change-avatar-btn').addEventListener('click', () => {
        userData.avatarImage = `https://picsum.photos/seed/${Math.random()}/200/200`;
        saveUserData();
        showToast(t('photoUpdated'));
        closeModal(); 
        showMyWallModal(); 
        if (currentView === 'community') {
            document.getElementById('view-content').innerHTML = getCommunityViewHTML();
            attachCommunityListeners();
        }
    });
    modalContainer.querySelector('#edit-profile-btn').addEventListener('click', () => {
        closeModal();
        showEditBioModal();
    });
}

function showFriendsModal() {
    const content = `
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-[var(--theme-primary)]">${t('friends')}</h3>
            <button class="close-modal-btn text-2xl" style="color: var(--theme-text-secondary);">&times;</button>
        </div>
        <div class="relative mb-4">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search" style="color: var(--theme-text-secondary);"></i></span>
            <input id="friend-search-input" type="text" placeholder="${t('searchFriends')}" class="w-full p-2 pl-10 border border-[var(--theme-input-border)] rounded-lg bg-[var(--theme-light-bg)]">
        </div>
        <div id="friends-list-container" class="max-h-60 overflow-y-auto no-scrollbar space-y-1 mb-4">
            <!-- Friend list will be rendered here -->
        </div>
        <button id="add-friend-btn" class="w-full bg-[var(--theme-primary-light)] text-white font-bold py-2 rounded-lg hover:bg-primary">${t('addFriends')}</button>
      </div>
    `;

    const { modalContainer, closeModal } = showModal(content);
    const searchInput = modalContainer.querySelector('#friend-search-input');
    const listContainer = modalContainer.querySelector('#friends-list-container');

    const renderFriendsList = (searchTerm = '') => {
        const filteredFriends = CONTENT[currentLanguage].FRIENDS.filter(f => f.name.toLowerCase().includes(searchTerm.toLowerCase()));
        
        if (filteredFriends.length === 0) {
            listContainer.innerHTML = `<p class="text-center py-4" style="color: var(--theme-text-secondary);">${t('noFriendsFound')}</p>`;
            return;
        }

        listContainer.innerHTML = filteredFriends.map(f => `
            <div data-friend-id="${f.id}" class="friend-item-btn flex items-center justify-between p-2 rounded-lg hover:bg-gray-100/50 cursor-pointer">
                <div class="flex items-center space-x-3">
                    <img src="${f.avatarImage}" alt="${f.name}" class="w-10 h-10 rounded-full object-cover"/>
                    <p class="font-semibold text-[var(--theme-dark-text)]">${f.name}</p>
                </div>
            </div>
        `).join('');

        listContainer.querySelectorAll('.friend-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const friendId = e.currentTarget.dataset.friendId;
                closeModal();
                showFriendProfileModal(friendId);
            });
        });
    };

    searchInput.addEventListener('input', (e) => renderFriendsList(e.target.value));
    modalContainer.querySelector('#add-friend-btn').addEventListener('click', () => showToast(t('comingSoon')));

    renderFriendsList(); // Initial render
}

function showFriendProfileModal(friendId) {
    const friend = CONTENT[currentLanguage].FRIENDS.find(f => f.id === friendId);
    if (!friend) return;

    const friendPostsHTML = friend.posts.map(post => `
        <div class="bg-[var(--theme-light-bg)] rounded-lg p-3 mb-3">
            <p class="text-sm text-[var(--theme-dark-text)]">${post}</p>
        </div>
    `).join('');

    const content = `
        <div class="relative">
             <button class="close-modal-btn absolute top-2 right-2 text-2xl bg-black/30 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-black/50 z-20">&times;</button>
             <div class="h-24 bg-gradient-to-r from-primary to-primary-light rounded-t-2xl relative">
                <img src="https://picsum.photos/seed/abstract-color-banner-${friend.id}/800/200" class="w-full h-full object-cover rounded-t-2xl opacity-50" />
             </div>
             <div class="px-4 pb-4">
                <div class="flex items-end -mt-10 relative z-10">
                    <img src="${friend.avatarImage}" alt="${friend.name}" class="w-20 h-20 rounded-full object-cover border-4 border-[var(--theme-card-bg)] shadow-md"/>
                    <h3 class="text-xl font-bold text-[var(--theme-dark-text)] ml-3 pb-1">${friend.name}</h3>
                </div>
                <p class="text-sm mt-2 mb-4" style="color: var(--theme-text-secondary);">${friend.bio}</p>
                
                <button data-friend-id="${friend.id}" id="send-dm-btn" class="w-full bg-[var(--theme-primary)] text-white font-bold py-2 rounded-lg mb-4"><i class="fas fa-comment-dots mr-2"></i> ${t('sendMessage')}</button>

                <h4 class="font-bold text-[var(--theme-dark-text)] border-b border-[var(--theme-input-border)] pb-2 mb-2">${t('recentPosts')}</h4>
                <div class="max-h-48 overflow-y-auto no-scrollbar pr-2">
                    ${friendPostsHTML}
                </div>
             </div>
        </div>`;
        
    const { closeModal } = showModal(content);
    
    document.getElementById('send-dm-btn').addEventListener('click', (e) => {
        const friendId = e.currentTarget.dataset.friendId;
        closeModal();
        currentView = 'dm';
        currentDmFriendId = friendId;
        render();
    });
}

function showMessagesModal() {
    const getLastMessagePreviewText = (msg) => {
        const prefix = msg.sender === 'user' ? `${t('you')}: ` : '';
        if (msg.type === 'photo') return msg.sender === 'user' ? t('youSentPhoto') : t('sentYouPhoto');
        if (msg.type === 'audio') return msg.sender === 'user' ? t('youSentAudio') : t('sentYouAudio');
        return prefix + msg.text;
    };

    const friendsData = CONTENT[currentLanguage].FRIENDS;
    const conversations = Object.keys(userData.directMessages).map(friendId => {
        const friend = friendsData.find(f => f.id === friendId);
        const messages = userData.directMessages[friendId];
        const lastMessage = messages[messages.length - 1];
        return { friend, lastMessage };
    }).filter(c => c.friend && c.lastMessage)
      .sort((a, b) => b.lastMessage.timestamp - a.lastMessage.timestamp);

    let conversationsHTML;
    if (conversations.length === 0) {
        conversationsHTML = `<p class="text-center py-6" style="color: var(--theme-text-secondary);">${t('noMessages')}</p>`;
    } else {
        conversationsHTML = conversations.map(({ friend, lastMessage }) => `
            <div data-friend-id="${friend.id}" class="dm-conversation-btn flex items-center p-3 rounded-lg hover:bg-gray-100/50 cursor-pointer">
                <img src="${friend.avatarImage}" alt="${friend.name}" class="w-12 h-12 rounded-full object-cover mr-3"/>
                <div class="flex-1 overflow-hidden">
                    <p class="font-bold text-[var(--theme-dark-text)] truncate">${friend.name}</p>
                    <p class="text-sm truncate" style="color: var(--theme-text-secondary);">${getLastMessagePreviewText(lastMessage)}</p>
                </div>
            </div>
        `).join('');
    }

    const content = `
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-[var(--theme-primary)]">${t('messages')}</h3>
            <button class="close-modal-btn text-2xl" style="color: var(--theme-text-secondary);">&times;</button>
        </div>
        <div class="max-h-80 overflow-y-auto no-scrollbar space-y-1">
            ${conversationsHTML}
        </div>
      </div>
    `;

    const { modalContainer, closeModal } = showModal(content);

    modalContainer.querySelectorAll('.dm-conversation-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const friendId = e.currentTarget.dataset.friendId;
            closeModal();
            currentView = 'dm';
            currentDmFriendId = friendId;
            render();
        });
    });
}


function showSOSModal() {
    const modalContainer = document.getElementById('modal-container');
    const professionals = CONTENT[currentLanguage].MENTAL_HEALTH_PROFESSIONALS;
    
    function renderSOSList() {
        const professionalListHTML = professionals.map(prof => `
            <div class="p-3 border-b border-[var(--theme-input-border)] last:border-b-0">
                <div class="flex items-center">
                    <img src="${prof.avatarImage}" class="w-12 h-12 rounded-full object-cover mr-3 shrink-0"/>
                    <div>
                        <p class="font-semibold text-[var(--theme-dark-text)]">${prof.name}</p>
                        <p class="text-sm" style="color: var(--theme-text-secondary);">${prof.specialty}</p>
                    </div>
                </div>
                <div class="flex justify-end mt-2">
                    <button data-professional-name="${prof.name}" class="info-btn shrink-0 bg-[var(--theme-primary-light)] text-white font-bold py-2 px-4 rounded-lg text-sm transition-transform transform hover:scale-105">${t('moreInfo')}</button>
                </div>
            </div>
        `).join('');

        modalContent.innerHTML = `
            <h2 class="text-xl font-bold text-[var(--theme-primary)] mb-4 text-center">${t('supportContacts')}</h2>
            <p class="text-center mb-4" style="color: var(--theme-text-secondary);">${t('supportSubtitle')}</p>
            <div class="space-y-2 max-h-64 overflow-y-auto no-scrollbar">${professionalListHTML}</div>
            <button id="close-sos-modal" class="w-full mt-6 bg-gray-200 text-dark-text font-bold py-2 px-4 rounded-lg">${t('close')}</button>
        `;

        modalContent.querySelectorAll('.info-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const professionalName = e.currentTarget.dataset.professionalName;
                renderProfessionalDetail(professionalName);
            });
        });
        document.getElementById('close-sos-modal').addEventListener('click', () => { modalContainer.innerHTML = ''; });
    }

    function renderProfessionalDetail(professionalName) {
        const prof = professionals.find(p => p.name === professionalName);
        if (!prof) return;

        modalContent.innerHTML = `
            <div class="p-2">
                <button id="back-to-sos-list" class="mb-4 text-[var(--theme-primary)] font-semibold"><i class="fas fa-arrow-left mr-2"></i> ${t('backToContacts')}</button>
                <div class="text-center">
                    <img src="${prof.avatarImage}" alt="${prof.name}" class="w-24 h-24 rounded-full object-cover mx-auto mb-4 border-4 border-[var(--theme-primary-light)] shadow-md" />
                    <h3 class="text-2xl font-bold text-[var(--theme-dark-text)]">${prof.name}</h3>
                    <p class="text-[var(--theme-primary)] font-semibold mb-4">${prof.specialty}</p>
                </div>
                <p class="text-sm text-center mb-4" style="color: var(--theme-text-secondary);">${prof.bio}</p>
                <div class="text-sm space-y-2 mb-6 bg-[var(--theme-light-bg)] p-3 rounded-lg">
                    <p class="text-[var(--theme-dark-text)]"><i class="fas fa-envelope w-5" style="color: var(--theme-text-secondary);"></i> ${prof.email}</p>
                    <p class="text-[var(--theme-dark-text)]"><i class="fas fa-globe w-5" style="color: var(--theme-text-secondary);"></i> ${prof.website}</p>
                </div>
                <div class="flex space-x-3">
                     <button data-professional-name="${prof.name}" class="call-btn flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg">${t('call')}</button>
                     <button class="schedule-btn flex-1 bg-secondary text-white font-bold py-3 px-4 rounded-lg">${t('scheduleAppointment')}</button>
                </div>
            </div>
        `;
        
        document.getElementById('back-to-sos-list').addEventListener('click', renderSOSList);
        modalContent.querySelector('.call-btn').addEventListener('click', () => renderCallingScreen(prof.name));
        modalContent.querySelector('.schedule-btn').addEventListener('click', () => showToast(t('comingSoon')));
    }

    function renderCallingScreen(professionalName) {
        modalContent.innerHTML = `
            <div class="text-center p-8">
                <div class="w-24 h-24 rounded-full bg-green-500 mx-auto flex items-center justify-center text-4xl text-white mb-6 pulsing-call">
                    <i class="fas fa-phone"></i>
                </div>
                <p style="color: var(--theme-text-secondary);">${t('calling')}</p>
                <h3 class="text-2xl font-bold text-[var(--theme-dark-text)]">${professionalName}</h3>
                <button id="cancel-call-btn" class="w-full mt-8 bg-red-500 text-white font-bold py-3 px-4 rounded-lg">${t('cancelCall')}</button>
            </div>
        `;

        document.getElementById('cancel-call-btn').addEventListener('click', () => renderProfessionalDetail(professionalName));
    }

    modalContainer.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
            <div id="sos-modal-content" class="bg-[var(--theme-card-bg)] rounded-2xl p-6 w-full max-w-md shadow-xl transition-all duration-300">
            </div>
        </div>`;
    
    const modalContent = document.getElementById('sos-modal-content');
    renderSOSList();
}



// ===================================================================================
// VI. APP INITIALIZATION
// ===================================================================================

function init() { 
    loadUserData();
    if (userData) {
        document.body.dataset.theme = userData.appTheme || 'totus';
        currentLanguage = userData.language || 'es';
    } else {
        onboardingStep = 0;
    }
    document.documentElement.lang = currentLanguage;
    render(); 
}
init();

});
</script>

</body>
</html>
